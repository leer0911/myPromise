# TS ç‰ˆ Promise è¶…è¯¦è§£

åœ¨ **npm å®‰å…¨æ€§é—®é¢˜éšæ—¶çˆ†å‘** çš„ä»Šå¤©ï¼Œä½œä¸ºå‰ç«¯å¼€å‘è€…çš„æˆ‘ä»¬åº”è¯¥å…·å¤‡æºç é˜…è¯»çš„èƒ½åŠ›ï¼Œæœ€å¥½èƒ½è‡ªå·±é€ ä¸ªè½®å­ã€‚

æ‹¿ axios è¿™ä¸ªæˆ‘ä»¬å¸¸ç”¨çš„ä¾èµ–æ¥è¯´ï¼Œå¦‚æœå“ªå¤©è¢«ç¯¡æ”¹äº†ï¼Œé‚£åæœçœŸä¸æ•¢æƒ³è±¡ã€‚å³ä¾¿è¿™åŸºæœ¬æ˜¯ä¸å¯èƒ½çš„ï¼Œä½†åˆ‡å›¾ä»”ä¸­çš„ç²¾è‹±ä¸èƒ½å°±æ­¤åœæ­¢è¿½æ±‚è¿›æ­¥çš„è„šæ­¥ã€‚å¥½åœ¨ç¬”è€…å‰äº›å¤©å†™äº†ç¯‡ [axios é‡æ„ç»éªŒåˆ†äº«](https://juejin.im/post/5bf7f1c0e51d455ed74f625c)ï¼Œå¤šå°‘å¯ä»¥è¯æ˜è‡ªå·±åŠªåŠ›è¿‡ã€‚ ğŸ˜‚

è¿™è¿˜ä¸å¤Ÿï¼Œç¿»äº†ä¸‹æœ€å¸¸ç”¨çš„ä¾èµ–ï¼Œå…¶ä¸­ [es6-promise](https://github.com/stefanpenner/es6-promise) ç‰¹åˆ«æƒ¹çœ¼ï¼Œæœ¬æ¥æ—©å°±æƒ³æ·±å…¥äº†è§£ Promise ï¼Œäºæ˜¯æ¯«ä¸çŠ¹è±«å†³å®šé€ å®ƒã€‚ç”±äºç¬”è€…åœ¨è¿‡æ¸¡åˆ° TypeScript ï¼Œæ‰€ä»¥æœ¬æ¬¡å¼€å‘ä¾æ—§ä¼šé‡‡ç”¨ TypeScript æ¥æ•²ã€‚

æœ¬æ–‡é€‚åˆä»é›¶äº†è§£æˆ–è€…æƒ³é‡æ–°æ·±å…¥ Promise çš„è¯»è€…ï¼Œå¹¶ä¸”å¯ä»¥å¾—åˆ°å¦‚ä¸‹çŸ¥è¯†ï¼š

- Promise é‡è¦çŸ¥è¯†ç‚¹

- Promise API å®ç°æ–¹æ³•

ç¬”è€…å¸Œæœ›ä»…é€šè¿‡çœ‹è¿™ä¸€ç¯‡æ–‡ç« å°±å¯ä»¥å¯¹ Promise æœ‰ä¸ªæ·±åˆ»çš„è®¤çŸ¥ï¼Œæ‰€ä»¥ä¼šä»æ–¹æ–¹é¢é¢è®² Promiseï¼Œè¯»è€…å¯é€‰è¯»ã€‚

## ä¸ºä»€ä¹ˆè¦å®ç° Promise

Promise å‡ºç°åœ¨ Es6 ï¼Œå¦‚æœ Es5 éœ€è¦ä½¿ç”¨ Promiseï¼Œé€šå¸¸éœ€è¦ç”¨åˆ° `Promise-polyfill` ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦å®ç°çš„æ˜¯ä¸€ä¸ª polyfillã€‚å®ç°å®ƒä¸ä»…æœ‰åŠ©äºæˆ‘ä»¬æ·±å…¥äº†è§£ Promise è€Œä¸”èƒ½å‡å°‘ä½¿ç”¨ä¸­çŠ¯é”™çš„æ¦‚ç‡ï¼Œä»¥è‡³äºè·å¾— Promise æœ€ä½³å®è·µã€‚

## Promise

> Promise è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆç»“æœï¼Œä¸ä¹‹è¿›è¡Œäº¤äº’çš„æ–¹å¼ä¸»è¦æ˜¯ then æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ³¨å†Œäº†ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºæ¥æ”¶ promise çš„ç»ˆå€¼æˆ–æœ¬ promise ä¸èƒ½æ‰§è¡Œçš„åŸå› ã€‚

æ¥çœ‹ç¬”è€…ç”¨å¿ƒç”»çš„ä¸€å¼  API ç»“æ„å›¾ ( çœ‹ä¸æ¸…æ¥šçš„å¯ä»¥è¿›æˆ‘çš„ [GitHub](https://github.com/leer0911/myPromise) çœ‹ï¼Œæœ‰å¤§å›¾å’Œ xmind æºæ–‡ä»¶ )ï¼š

![](img/1.png)

ä¸Šå›¾åªæ˜¯ä¸€ä¸ª **Promise çš„ API è“å›¾**ï¼Œå…¶å® `Promises/A+` è§„èŒƒå¹¶ä¸è®¾è®¡å¦‚ä½•åˆ›å»ºã€è§£å†³å’Œæ‹’ç» promiseï¼Œè€Œæ˜¯ä¸“æ³¨äºæä¾›ä¸€ä¸ªé€šç”¨çš„ then æ–¹æ³•ã€‚æ‰€ä»¥ï¼ŒPromise/A+ è§„èŒƒçš„å®ç°å¯ä»¥ä¸é‚£äº›ä¸å¤ªè§„èŒƒä½†å¯ç”¨çš„å®ç°èƒ½è‰¯å¥½å…±å­˜ã€‚å¦‚æœå¤§å®¶éƒ½æŒ‰è§„èŒƒæ¥ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰é‚£ä¹ˆå¤šå…¼å®¹é—®é¢˜ã€‚(PSï¼šåŒ…æ‹¬ web æ ‡å‡† ) æ¥ç€èŠä¸‹ `Promises/A+`ï¼Œçœ‹è¿‡çš„å¯ä»¥è·³è¿‡ã€‚

## Promises/A+

æ‰€æœ‰ Promise çš„å®ç°éƒ½ç¦»ä¸å¼€ [Promises/A+](https://promisesaplus.com/) è§„èŒƒï¼Œå†…å®¹ä¸å¤šï¼Œå»ºè®®å¤§å®¶å¯ä»¥è¿‡ä¸€éã€‚è¿™è¾¹è®²ä¸€äº›è§„èŒƒä¸­é‡è¦çš„ç‚¹

### æœ¯è¯­

![](img/7.png)

- `Promise` ä¸€ä¸ªæ‹¥æœ‰ `then` æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œå…¶è¡Œä¸ºç¬¦åˆ `Promises/A+` è§„èŒƒï¼›

- `thenable` ä¸€ä¸ªå®šä¹‰äº† `then` æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œä¹Ÿå¯è§†ä½œ â€œæ‹¥æœ‰ `then` æ–¹æ³•â€

- `å€¼ï¼ˆvalueï¼‰` æŒ‡**ä»»ä½•** JavaScript çš„**åˆæ³•å€¼**ï¼ˆåŒ…æ‹¬ undefined , thenable å’Œ promiseï¼‰

- `å¼‚å¸¸ï¼ˆexceptionï¼‰` ä½¿ç”¨ `throw` è¯­å¥æŠ›å‡ºçš„ä¸€ä¸ªå€¼

- `æ®å› ï¼ˆreasonï¼‰` è¡¨ç¤ºä¸€ä¸ª promise çš„æ‹’ç»åŸå› ã€‚

### Promise çš„çŠ¶æ€

> ä¸€ä¸ª Promise çš„å½“å‰çŠ¶æ€**å¿…é¡»**ä¸ºä»¥ä¸‹ä¸‰ç§çŠ¶æ€ä¸­çš„ä¸€ç§ï¼šç­‰å¾…æ€ï¼ˆPendingï¼‰ã€æ‰§è¡Œæ€ï¼ˆFulfilledï¼‰å’Œæ‹’ç»æ€ï¼ˆRejectedï¼‰ã€‚

- `ç­‰å¾…æ€ï¼ˆPendingï¼‰`

  **å¤„äºç­‰å¾…æ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ï¼š`å¯ä»¥`è¿ç§»è‡³æ‰§è¡Œæ€æˆ–æ‹’ç»æ€**

- `æ‰§è¡Œæ€ï¼ˆFulfilledï¼‰`

  **å¤„äºæ‰§è¡Œæ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ï¼š`ä¸èƒ½`è¿ç§»è‡³å…¶ä»–ä»»ä½•çŠ¶æ€ï¼Œå¿…é¡»æ‹¥æœ‰ä¸€ä¸ª`ä¸å¯å˜`çš„`ç»ˆå€¼`**

- `æ‹’ç»æ€ï¼ˆRejectedï¼‰`

  **å¤„äºæ‹’ç»æ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ï¼š`ä¸èƒ½`è¿ç§»è‡³å…¶ä»–ä»»ä½•çŠ¶æ€ï¼Œå¿…é¡»æ‹¥æœ‰ä¸€ä¸ª`ä¸å¯å˜`çš„`æ®å› `**

> è¿™é‡Œçš„ä¸å¯å˜æŒ‡çš„æ˜¯æ’ç­‰ï¼ˆå³å¯ç”¨ `===` åˆ¤æ–­ç›¸ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯æ„å‘³ç€æ›´æ·±å±‚æ¬¡çš„ä¸å¯å˜ï¼ˆ æŒ‡å½“ value æˆ– reason ä¸æ˜¯[åŸºæœ¬å€¼](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures)æ—¶ï¼Œåªè¦æ±‚å…¶å¼•ç”¨åœ°å€ç›¸ç­‰ï¼Œä½†å±æ€§å€¼å¯è¢«æ›´æ”¹ï¼‰ã€‚

### Then æ–¹æ³•

> ä¸€ä¸ª promise å¿…é¡»æä¾›ä¸€ä¸ª then æ–¹æ³•ä»¥è®¿é—®å…¶å½“å‰å€¼ã€ç»ˆå€¼å’Œæ®å› ã€‚

promise çš„ then æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š

```js
promise.then(onFulfilled, onRejected);
```

- `onFulfilled` å’Œ `onRejected` éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚

- å¦‚æœ `onFulfilled` æ˜¯å‡½æ•°ï¼Œå½“ promise **æ‰§è¡Œç»“æŸ**åå…¶å¿…é¡»è¢«è°ƒç”¨ï¼Œå…¶**ç¬¬ä¸€ä¸ªå‚æ•°**ä¸º promise çš„**ç»ˆå€¼**ï¼Œåœ¨ promise æ‰§è¡Œç»“æŸå‰å…¶**ä¸å¯è¢«è°ƒç”¨**ï¼Œå…¶è°ƒç”¨æ¬¡æ•°ä¸å¯è¶…è¿‡ä¸€æ¬¡

- å¦‚æœ `onRejected` æ˜¯å‡½æ•°ï¼Œå½“ promise è¢«**æ‹’ç»**æ‰§è¡Œåå…¶å¿…é¡»è¢«è°ƒç”¨ï¼Œå…¶**ç¬¬ä¸€ä¸ªå‚æ•°**ä¸º promise çš„**æ®å› **ï¼Œåœ¨ promise è¢«æ‹’ç»æ‰§è¡Œå‰å…¶**ä¸å¯è¢«è°ƒç”¨**ï¼Œå…¶è°ƒç”¨æ¬¡æ•°ä¸å¯è¶…è¿‡ä¸€æ¬¡

- `onFulfilled` å’Œ `onRejected` åªæœ‰åœ¨æ‰§è¡Œç¯å¢ƒå †æ ˆä»…åŒ…å«å¹³å°ä»£ç  ( æŒ‡çš„æ˜¯å¼•æ“ã€ç¯å¢ƒä»¥åŠ promise çš„å®æ–½ä»£ç  )æ—¶æ‰å¯è¢«è°ƒç”¨

- å®è·µä¸­è¦ç¡®ä¿ `onFulfilled` å’Œ `onRejected` æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ `then` æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚

- `onFulfilled` å’Œ `onRejected` å¿…é¡»è¢«ä½œä¸ºå‡½æ•°è°ƒç”¨å³æ²¡æœ‰ this å€¼ ( ä¹Ÿå°±æ˜¯è¯´åœ¨ ä¸¥æ ¼æ¨¡å¼ï¼ˆstrictï¼‰ ä¸­ï¼Œå‡½æ•° this çš„å€¼ä¸º undefined ï¼›åœ¨éä¸¥æ ¼æ¨¡å¼ä¸­å…¶ä¸ºå…¨å±€å¯¹è±¡ã€‚)

- then æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise è°ƒç”¨å¤šæ¬¡

- then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡

### Then å‚æ•° (å‡½æ•°) è¿”å›å€¼

å¸Œæœ›è¯»è€…å¯ä»¥è®¤çœŸçœ‹è¿™éƒ¨åˆ†çš„å†…å®¹ï¼Œå¯¹äºç†è§£ promise çš„ `then` æ–¹æ³•æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚

å…ˆæ¥çœ‹ä¸‹ promise æ‰§è¡Œè¿‡ç¨‹ï¼š

![](img/8.png)

å¤§è‡´çš„è¿‡ç¨‹æ˜¯ï¼Œpromise ä¼šä» `pending` è½¬ä¸º `fulfilled` æˆ– `rejected` ï¼Œç„¶åå¯¹åº”è°ƒç”¨ `then` æ–¹æ³•å‚æ•°çš„ `onFulfilled` æˆ– `onRejected` ï¼Œæœ€ç»ˆè¿”å› `promise` å¯¹è±¡ã€‚

è¿›ä¸€æ­¥ç†è§£ï¼Œå‡å®š  æœ‰å¦‚ä¸‹ä¸¤ä¸ª promiseï¼š

```js
promise2 = promise1.then(onFulfilled, onRejected);
```

ä¼šæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

1. å¦‚æœ `onFulfilled` æˆ–è€… `onRejected` **æŠ›å‡ºå¼‚å¸¸ e** ï¼Œåˆ™ promise2 **å¿…é¡»æ‹’ç»æ‰§è¡Œ**ï¼Œå¹¶è¿”å› `æ‹’å›  e`

2. å¦‚æœ `onFulfilled` **ä¸æ˜¯å‡½æ•°** ä¸” promise1 æˆåŠŸæ‰§è¡Œï¼Œ promise2 å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å› **ç›¸åŒçš„å€¼**

3. å¦‚æœ `onRejected` **ä¸æ˜¯å‡½æ•°** ä¸” promise1 æ‹’ç»æ‰§è¡Œï¼Œ promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å› **ç›¸åŒçš„æ®å› **

å¸Œæœ›è¿›ä¸€æ­¥ææ‡‚çš„ï¼Œå¯ä»¥å°†ä¸‹é¢ä»£ç æ‹·è´åˆ° chrome æ§åˆ¶å°æˆ–å…¶ä»–å¯æ‰§è¡Œç¯å¢ƒæ„Ÿå—ä¸€ä¸‹ï¼š

```js
// é€šè¿‡æ”¹å˜ isResolve æ¥åˆ‡æ¢ promise1 çš„çŠ¶æ€
const isResolve = true;

const promise1 = new Promise((resolve, reject) => {
  if (isResolve) {
    resolve('promise1 æ‰§è¡Œæ€');
  } else {
    reject('promise1 æ‹’ç»æ€');
  }
});

// ä¸€ã€promise1 å¤„äº resolve ä»¥åŠ onFulfilled æŠ›å‡ºå¼‚å¸¸ çš„æƒ…å†µ
// promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å› 
promise1
  .then(() => {
    throw 'æŠ›å‡ºå¼‚å¸¸!';
  })
  .then(
    value => {
      console.log(value);
    },
    reason => {
      console.log(reason);
    }
  );

// äºŒã€promise1 å¤„äº resolve ä»¥åŠ onFulfilled ä¸æ˜¯å‡½æ•°çš„æƒ…å†µ
// promise2 å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„å€¼
promise1.then().then(value => {
  console.log(value);
});

// ä¸‰ã€promise1 å¤„äº reject ä»¥åŠ onRejected ä¸æ˜¯å‡½æ•°çš„æƒ…å†µ
// promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›æ‹’å› 
promise1.then().then(
  () => {},
  reason => {
    console.log(reason);
  }
);

// å››ã€promise1 å¤„äº resolve ä»¥åŠ onFulfilled æœ‰è¿”å›å€¼æ—¶
promise1
  .then(value => {
    return value;
  })
  .then(value => {
    console.log(value);
  });
```

ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æƒ…å†µï¼Œå®ƒå…³ç³»åˆ°ä¸šåŠ¡åœºæ™¯ä¸­ä¼ å€¼é—®é¢˜ï¼š

4. `onFulfilled` æˆ–è€… `onRejected` è¿”å› **ä¸€ä¸ª JavaScript åˆæ³•å€¼** çš„æƒ…å†µ

æˆ‘ä»¬å…ˆæ¥å‡å®š then æ–¹æ³•å†…éƒ¨æœ‰ä¸€ä¸ªå«åš `[[Resolve]]` çš„æ–¹æ³•ç”¨äºå¤„ç†è¿™ç§ç‰¹æ®Šæƒ…å†µï¼Œä¸‹é¢æ¥å…·ä½“äº†è§£ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚

### `[[Resolve]]` æ–¹æ³•

ä¸€èˆ¬åƒ `[[...]]` è¿™æ ·çš„è®¤ä¸ºæ˜¯å†…éƒ¨å®ç°ï¼Œå¦‚ `[[Resolve]]`ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š

```js
[[Resolve]](promise, x);
```

å¯¹äº `x` å€¼ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

- `x` æœ‰ **then æ–¹æ³•** ä¸”çœ‹ä¸Šå»åƒä¸€ä¸ª `Promise`

- `x` ä¸ºå¯¹è±¡æˆ–å‡½æ•°

- `x` ä¸º `Promise`

å¦å¤– promise ä¸èƒ½ä¸ x ç›¸ç­‰å³ `promise !== x`,å¦åˆ™ï¼š

![](./img/same.png)

ä¸‹é¢æ¥çœ‹å¼ å›¾ï¼Œå¤§è‡´äº†è§£ä¸‹å„æƒ…å†µçš„åº”å¯¹æ–¹å¼ï¼š

![](./img/resolve.png)

### `Promise/A+` å°ç»“

è‡³æ­¤ï¼Œ`Promise/A+` éœ€è¦  äº†è§£çš„å°±è®²å®Œäº†ã€‚ä¸»è¦åŒ…æ‹¬äº†ï¼Œæœ¯è¯­ä»¥åŠ Then æ–¹æ³•çš„ç”¨æ³•å’Œç›¸å…³æ³¨æ„äº‹é¡¹ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œthen æ–¹æ³•ä¸­å‚æ•°è¿”å›å€¼çš„å¤„ç†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨è§„èŒƒçš„åŸºç¡€ä¸Šï¼Œç”¨ TypeScript æ¥  å®ç° Promiseã€‚

## Promise å®ç°

Promise æœ¬èº«æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå³å¯ä»¥å®ç°ä¸ºç±»ã€‚æ¥ä¸‹æ¥ï¼Œä¸»è¦å›´ç»•å®ç°ä¸€ä¸ª Promise ç±»æ¥è®²ã€‚

å…ˆæ¥çœ‹ä¸‹ä¸€ä¸ªæ ‡å‡† promise å¯¹è±¡å…·å¤‡çš„å±æ€§å’Œæ–¹æ³•ï¼Œåšåˆ°å¿ƒä¸­æœ‰æ•°ã€‚

![](./img/3.png)
![](./img/2.png)

ä¸‹é¢å¼€å§‹æ­£å¼çš„å®ç°éƒ¨åˆ†

### å£°æ˜æ–‡ä»¶

åœ¨å¼€å§‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸‹ï¼Œç”¨ TypeScript å†™ Promise æ¶‰åŠçš„ä¸€äº›ç±»å‹å£°æ˜ã€‚å¯ä»¥çœ‹è¿™ä¸ª[å£°æ˜æ–‡ä»¶](https://github.com/leer0911/myPromise/blob/master/index.d.ts)ã€‚

ä¸»è¦åŒ…æ‹¬ï¼š

![](./img/4.png)

### æ„é€ å‡½æ•°

æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ª `Resolver` ç±»å‹çš„å‡½æ•°ä½œä¸ºå”¯ä¸€å‚æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œresolve å’Œ rejectã€‚ç”¨äºå¤„ç† promise çŠ¶æ€ã€‚

```ts
class Promise {
  // å†…éƒ¨å±æ€§
  private ['[[PromiseStatus]]']: PromiseStatus = 'pending';
  private ['[[PromiseValue]]']: any = undefined;

  subscribes: any[] = [];

  constructor(resolver: Resolver<R>) {
    this[PROMISE_ID] = id++;
    // resolver å¿…é¡»ä¸ºå‡½æ•°
    typeof resolver !== 'function' && resolverError();
    // ä½¿ç”¨ Promise æ„é€ å‡½æ•°ï¼Œéœ€è¦ç”¨ new æ“ä½œç¬¦
    this instanceof Promise ? this.init(resolver) : constructorError();
  }

  private init(resolver: Resolver<R>) {
    try {
      // ä¼ å…¥ä¸¤ä¸ªå‚æ•°åŠç”¨æˆ·ä¼ å…¥çš„å€¼ã€‚
      resolver(
        value => {
          this.mockResolve(value);
        },
        reason => {
          this.mockReject(reason);
        }
      );
    } catch (e) {
      this.mockReject(e);
    }
    return null;
  }

  private mockResolve(){
    // TODO
  }
  private mockReject(){
    // TODO
  }
}
```

### [[Resolve]] å®ç°

å‰é¢ Promise è§„èŒƒéƒ¨åˆ†ï¼Œæˆ‘ä»¬äº†è§£åˆ° `[[Resolve]]` å±äºå†…éƒ¨å®ç°ï¼Œç”¨äºå¤„ç† then å‚æ•°çš„è¿”å›å€¼ã€‚è¿™é‡Œä¸»è¦å®ç°èƒ½å¤Ÿå¤„ç†æ„é€ å‡½æ•°é‡Œé¢çš„ `resolve(value)` value ç»ˆå€¼çš„åä¸º `mockResolve` çš„æ–¹æ³•ã€‚

![](./img/5.png)

ä»å‰é¢è§„èŒƒå†…å®¹å¯ä»¥å¾—çŸ¥ï¼Œ`mockResolve` æ–¹æ³•æ¥å—çš„ value å¯èƒ½ä¸º Promiseï¼Œthenableï¼Œå…¶ä»–ã€‚

```ts
private mockResolve(value: any) {
  // resolve ä¸èƒ½ä¼ å…¥å½“å‰è¿”å›çš„ promise
  // å³ `[[Resolve]](promise,x)` ä¸­ promise ï¼== x
  if (value === this) {
    this.mockReject(resolveSelfError);
    return;
  }
  // éå¯¹è±¡å’Œå‡½æ•°ï¼Œç›´æ¥å¤„ç†
  if (!isObjectORFunction(value)) {
    this.fulfill(value);
    return;
  }
  // å¤„ç†ä¸€äº›åƒ promise çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œå³ thenable
  this.handleLikeThenable(value, this.getThen(value));
}
```



## å‚è€ƒ

[Promises/A+](https://promisesaplus.com/)
