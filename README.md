# ä» TS é€  Promise çš„è¿‡ç¨‹å»ºç«‹å‰ç«¯å®‰å…¨æ„Ÿ

ä½ è¿˜åœ¨ç”¨ npm çš„ star æ•°æ¥é€‰æ‹©ä¾èµ–å—ï¼Ÿåœ¨ **npm å®‰å…¨æ€§é—®é¢˜éšæ—¶çˆ†å‘** çš„ä»Šå¤©ï¼Œä½œä¸ºå‰ç«¯å¼€å‘è€…çš„æˆ‘ä»¬åº”è¯¥å…·å¤‡æºç é˜…è¯»çš„èƒ½åŠ›ï¼Œæœ€å¥½çŸ¥é“è‡ªå·±åœ¨ç”¨ä»€ä¹ˆï¼Œè¿™æ ·åœ¨ä½¿ç”¨å¤–éƒ¨ `npm` ä¾èµ–æ—¶æ‰æœ‰å®‰å…¨æ„Ÿä¸æ˜¯ä¹ˆ?

> æœ€è¿‘é‡åˆ°ä¸€ä¸ªç»†æ€ææçš„é—®é¢˜ï¼Œç¬”è€…æœ€è¿‘è€æ˜¯æ”¶åˆ°é˜²è„±å¹¿å‘Šæ¨é€äº¦æˆ–æ˜¯ä¸€äº›ä¸ç¬”è€…æœ€è¿‘è¯´å‡ºæ¥çš„è¯ç›¸å…³çš„å¹¿å‘Šï¼Œä»¥å‰åªçŸ¥é“ç½‘ä¸Šçš„ä¿¡æ¯æµä¼šè¢«çªƒæ®ï¼Œå¦‚ä»Šéš¾ä¸æˆè¯­éŸ³ä¹Ÿä¼šç›‘å¬çªƒå–äº†ï¼Ÿï¼Ÿï¼Ÿå“å¾—æˆ‘èµ¶ç´§å…³æ‰äº†æ‰€æœ‰éº¦çš„æƒé™ã€‚è™½ç„¶æˆ‘ä»¬ä¸èƒ½è‡ªå·±é€ ä¸ªæ‰‹æœºï¼Œä½†ä¹Ÿä¸èƒ½æ´»å¾—æ²¡æœ‰å®‰å…¨æ„Ÿã€‚

æ‹¿ axios è¿™ä¸ªæˆ‘ä»¬å¸¸ç”¨çš„ä¾èµ–æ¥è¯´ï¼Œå¦‚æœå“ªå¤©è¢«ç¯¡æ”¹äº†ï¼Œé‚£åæœçœŸä¸æ•¢æƒ³è±¡ã€‚å³ä¾¿è¿™åŸºæœ¬æ˜¯ä¸å¯èƒ½çš„ï¼Œä½†åˆ‡å›¾ä»”ä¸­çš„ç²¾è‹±ä¸èƒ½å°±æ­¤åœæ­¢è¿½æ±‚è¿›æ­¥çš„è„šæ­¥ã€‚å¥½åœ¨ç¬”è€…å‰äº›å¤©å†™äº†ç¯‡ [axios é‡æ„ç»éªŒåˆ†äº«](https://juejin.im/post/5bf7f1c0e51d455ed74f625c)ï¼Œå¤šå°‘å¯ä»¥è¯æ˜è‡ªå·±åŠªåŠ›è¿‡ã€‚ ğŸ˜‚

è¿™è¿˜ä¸å¤Ÿï¼Œç¿»äº†ä¸‹æœ€å¸¸ç”¨çš„ä¾èµ–ï¼Œå…¶ä¸­ [es6-promise](https://github.com/stefanpenner/es6-promise) ç‰¹åˆ«æƒ¹çœ¼ (æºç æ¯”è¾ƒæ™¦æ¶©éš¾æ‡‚ï¼Œè¯´ç™½äº†å°±æ˜¯æœ‰ç‚¹ä¹±)ï¼Œæœ¬æ¥æ—©å°±æƒ³æ·±å…¥äº†è§£ Promise ï¼Œäºæ˜¯æ¯«ä¸çŠ¹è±«å†³å®šé€ å®ƒã€‚ç”±äºç¬”è€…åœ¨è¿‡æ¸¡åˆ° TypeScript ï¼Œæ‰€ä»¥æœ¬æ¬¡å¼€å‘ä¾æ—§ä¼šé‡‡ç”¨ TypeScript æ¥æ•²ã€‚

è¿™åº”è¯¥æ˜¯ç¬”è€…æœ€åä¸€æ¬¡ç”¨ TypeScript å† ååˆ†äº«æ–‡ç« ï¼Œå†è§ ğŸ¤ï¼Œæˆ‘å·²ç»å¯ä»¥å®‰å…¨ä¸Šè·¯äº†ã€‚( å–Šäº†é‚£ä¹ˆå¤šæ¬¡ï¼Œå¿«ä¸Šè½¦ï¼Œéƒ½æ²¡æœ‰å¤šå°‘äººä¸Šè½¦ï¼Œé‚£æˆ‘å°±å…ˆèµ°äº†ã€‚)

æœ¬æ–‡é€‚åˆä»é›¶äº†è§£æˆ–è€…æƒ³é‡æ–°æ·±å…¥ç ”ç©¶ Promise çš„è¯»è€…ï¼Œå¹¶ä¸”å¯ä»¥å¾—åˆ°å¦‚ä¸‹çŸ¥è¯†ï¼š

- Promise **é‡è¦**çŸ¥è¯†ç‚¹

- Promise API å®ç°æ–¹æ³•

- å‰ç«¯ä½•æ¥å®‰å…¨æ„Ÿ

ç¬”è€…å¸Œæœ›è¯»è€…å¯ä»¥ä»…é€šè¿‡çœ‹**ä»…æ­¤ä¸€ç¯‡æ–‡ç« **å°±å¯ä»¥å¯¹ Promise æœ‰ä¸ªæ·±åˆ»çš„è®¤çŸ¥ï¼Œ**å¹¶ä¸”å¯ä»¥è‡ªå·±å®ç°ä¸€ä¸ª Promise ç±»**ã€‚æ‰€ä»¥ä¼šä»æ–¹æ–¹é¢é¢è®² Promiseï¼Œå†…å®¹å¯èƒ½ä¼šæ¯”è¾ƒå¤šï¼Œå»ºè®®è¯»è€…é€‰è¯»ã€‚

## ä¸ºä»€ä¹ˆè¦å®ç° Promise

Promise å‡ºç°åœ¨ Es6 ï¼Œå¦‚æœ Es5 éœ€è¦ä½¿ç”¨ Promiseï¼Œé€šå¸¸éœ€è¦ç”¨åˆ° `Promise-polyfill` ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬è¦å®ç°çš„æ˜¯ä¸€ä¸ª polyfillã€‚å®ç°å®ƒä¸ä»…æœ‰åŠ©äºæˆ‘ä»¬æ·±å…¥äº†è§£ Promise è€Œä¸”èƒ½å‡å°‘ä½¿ç”¨ä¸­çŠ¯é”™çš„æ¦‚ç‡ï¼Œä»¥è‡³äºè·å¾— Promise æœ€ä½³å®è·µã€‚

ä»å¦å¤–ä¸€ä¸ªè§’åº¦æ¥è¯´é‡æ–°å®ç°æŸä¸ªä¾èµ–ä¹Ÿæ˜¯ä¸€ç§æºç è§£è¯»çš„æ–¹å¼ï¼ŒåšæŒè¿™ä¹ˆåšï¼Œæ„å‘³ç€è§£è¯»æºç èƒ½åŠ›çš„æå‡ã€‚

## Promise

> Promise è¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆç»“æœï¼Œä¸ä¹‹è¿›è¡Œäº¤äº’çš„æ–¹å¼ä¸»è¦æ˜¯ then æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ³¨å†Œäº†ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºæ¥æ”¶ promise çš„ç»ˆå€¼æˆ–æœ¬ promise ä¸èƒ½æ‰§è¡Œçš„åŸå› ã€‚

æ¥çœ‹ç¬”è€…ç”¨å¿ƒç”»çš„ä¸€å¼  API ç»“æ„å›¾ ( çœ‹ä¸æ¸…æ¥šçš„å¯ä»¥è¿›æˆ‘çš„ [GitHub](https://github.com/leer0911/myPromise) çœ‹ï¼Œæœ‰å¤§å›¾å’Œ xmind æºæ–‡ä»¶ )ï¼š

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/1.png)

ä¸Šå›¾åªæ˜¯ä¸€ä¸ª **Promise çš„ API è“å›¾**ï¼Œå…¶å® `Promises/A+` è§„èŒƒå¹¶ä¸è®¾è®¡å¦‚ä½•åˆ›å»ºã€è§£å†³å’Œæ‹’ç» promiseï¼Œè€Œæ˜¯ä¸“æ³¨äºæä¾›ä¸€ä¸ªé€šç”¨çš„ then æ–¹æ³•ã€‚æ‰€ä»¥ï¼ŒPromise/A+ è§„èŒƒçš„å®ç°å¯ä»¥ä¸é‚£äº›ä¸å¤ªè§„èŒƒä½†å¯ç”¨çš„å®ç°èƒ½è‰¯å¥½å…±å­˜ã€‚å¦‚æœå¤§å®¶éƒ½æŒ‰è§„èŒƒæ¥ï¼Œé‚£ä¹ˆå°±æ²¡æœ‰é‚£ä¹ˆå¤šå…¼å®¹é—®é¢˜ã€‚(PSï¼šåŒ…æ‹¬ web æ ‡å‡† ) æ¥ç€èŠä¸‹ `Promises/A+`ï¼Œçœ‹è¿‡çš„å¯ä»¥è·³è¿‡ã€‚

## Promises/A+

æ‰€æœ‰ Promise çš„å®ç°éƒ½ç¦»ä¸å¼€ [Promises/A+](https://promisesaplus.com/) è§„èŒƒï¼Œå†…å®¹ä¸å¤šï¼Œå»ºè®®å¤§å®¶å¯ä»¥è¿‡ä¸€éã€‚è¿™è¾¹è®²ä¸€äº›è§„èŒƒä¸­é‡è¦çš„ç‚¹

### æœ¯è¯­

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/7.png)

- `Promise` ä¸€ä¸ªæ‹¥æœ‰ `then` æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œå…¶è¡Œä¸ºç¬¦åˆ `Promises/A+` è§„èŒƒï¼›

- `thenable` ä¸€ä¸ªå®šä¹‰äº† `then` æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œä¹Ÿå¯è§†ä½œ â€œæ‹¥æœ‰ `then` æ–¹æ³•â€

- `å€¼ï¼ˆvalueï¼‰` æŒ‡**ä»»ä½•** JavaScript çš„**åˆæ³•å€¼**ï¼ˆåŒ…æ‹¬ undefined , thenable å’Œ promiseï¼‰

- `å¼‚å¸¸ï¼ˆexceptionï¼‰` ä½¿ç”¨ `throw` è¯­å¥æŠ›å‡ºçš„ä¸€ä¸ªå€¼

- `æ®å› ï¼ˆreasonï¼‰` è¡¨ç¤ºä¸€ä¸ª promise çš„æ‹’ç»åŸå› ã€‚

### Promise çš„çŠ¶æ€

> ä¸€ä¸ª Promise çš„å½“å‰çŠ¶æ€**å¿…é¡»**ä¸ºä»¥ä¸‹ä¸‰ç§çŠ¶æ€ä¸­çš„ä¸€ç§ï¼šç­‰å¾…æ€ï¼ˆPendingï¼‰ã€æ‰§è¡Œæ€ï¼ˆFulfilledï¼‰å’Œæ‹’ç»æ€ï¼ˆRejectedï¼‰ã€‚

- `ç­‰å¾…æ€ï¼ˆPendingï¼‰`

  **å¤„äºç­‰å¾…æ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ï¼š`å¯ä»¥`è¿ç§»è‡³æ‰§è¡Œæ€æˆ–æ‹’ç»æ€**

- `æ‰§è¡Œæ€ï¼ˆFulfilledï¼‰`

  **å¤„äºæ‰§è¡Œæ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ï¼š`ä¸èƒ½`è¿ç§»è‡³å…¶ä»–ä»»ä½•çŠ¶æ€ï¼Œå¿…é¡»æ‹¥æœ‰ä¸€ä¸ª`ä¸å¯å˜`çš„`ç»ˆå€¼`**

- `æ‹’ç»æ€ï¼ˆRejectedï¼‰`

  **å¤„äºæ‹’ç»æ€æ—¶ï¼Œpromise éœ€æ»¡è¶³ï¼š`ä¸èƒ½`è¿ç§»è‡³å…¶ä»–ä»»ä½•çŠ¶æ€ï¼Œå¿…é¡»æ‹¥æœ‰ä¸€ä¸ª`ä¸å¯å˜`çš„`æ®å› `**

> è¿™é‡Œçš„ä¸å¯å˜æŒ‡çš„æ˜¯æ’ç­‰ï¼ˆå³å¯ç”¨ `===` åˆ¤æ–­ç›¸ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯æ„å‘³ç€æ›´æ·±å±‚æ¬¡çš„ä¸å¯å˜ï¼ˆ æŒ‡å½“ value æˆ– reason ä¸æ˜¯[åŸºæœ¬å€¼](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Data_structures)æ—¶ï¼Œåªè¦æ±‚å…¶å¼•ç”¨åœ°å€ç›¸ç­‰ï¼Œä½†å±æ€§å€¼å¯è¢«æ›´æ”¹ï¼‰ã€‚

### Then æ–¹æ³•

> ä¸€ä¸ª promise å¿…é¡»æä¾›ä¸€ä¸ª then æ–¹æ³•ä»¥è®¿é—®å…¶å½“å‰å€¼ã€ç»ˆå€¼å’Œæ®å› ã€‚

promise çš„ then æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š

```js
promise.then(onFulfilled, onRejected);
```

- `onFulfilled` å’Œ `onRejected` éƒ½æ˜¯å¯é€‰å‚æ•°ã€‚

- å¦‚æœ `onFulfilled` æ˜¯å‡½æ•°ï¼Œå½“ promise **æ‰§è¡Œç»“æŸ**åå…¶å¿…é¡»è¢«è°ƒç”¨ï¼Œå…¶**ç¬¬ä¸€ä¸ªå‚æ•°**ä¸º promise çš„**ç»ˆå€¼**ï¼Œåœ¨ promise æ‰§è¡Œç»“æŸå‰å…¶**ä¸å¯è¢«è°ƒç”¨**ï¼Œå…¶è°ƒç”¨æ¬¡æ•°ä¸å¯è¶…è¿‡ä¸€æ¬¡

- å¦‚æœ `onRejected` æ˜¯å‡½æ•°ï¼Œå½“ promise è¢«**æ‹’ç»**æ‰§è¡Œåå…¶å¿…é¡»è¢«è°ƒç”¨ï¼Œå…¶**ç¬¬ä¸€ä¸ªå‚æ•°**ä¸º promise çš„**æ®å› **ï¼Œåœ¨ promise è¢«æ‹’ç»æ‰§è¡Œå‰å…¶**ä¸å¯è¢«è°ƒç”¨**ï¼Œå…¶è°ƒç”¨æ¬¡æ•°ä¸å¯è¶…è¿‡ä¸€æ¬¡

- `onFulfilled` å’Œ `onRejected` åªæœ‰åœ¨æ‰§è¡Œç¯å¢ƒå †æ ˆä»…åŒ…å«å¹³å°ä»£ç  ( æŒ‡çš„æ˜¯å¼•æ“ã€ç¯å¢ƒä»¥åŠ promise çš„å®æ–½ä»£ç  )æ—¶æ‰å¯è¢«è°ƒç”¨

- å®è·µä¸­è¦ç¡®ä¿ `onFulfilled` å’Œ `onRejected` æ–¹æ³•å¼‚æ­¥æ‰§è¡Œï¼Œä¸”åº”è¯¥åœ¨ `then` æ–¹æ³•è¢«è°ƒç”¨çš„é‚£ä¸€è½®äº‹ä»¶å¾ªç¯ä¹‹åçš„æ–°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œã€‚

- `onFulfilled` å’Œ `onRejected` å¿…é¡»è¢«ä½œä¸ºå‡½æ•°è°ƒç”¨å³æ²¡æœ‰ this å€¼ ( ä¹Ÿå°±æ˜¯è¯´åœ¨ ä¸¥æ ¼æ¨¡å¼ï¼ˆstrictï¼‰ ä¸­ï¼Œå‡½æ•° this çš„å€¼ä¸º undefined ï¼›åœ¨éä¸¥æ ¼æ¨¡å¼ä¸­å…¶ä¸ºå…¨å±€å¯¹è±¡ã€‚)

- then æ–¹æ³•å¯ä»¥è¢«åŒä¸€ä¸ª promise è°ƒç”¨å¤šæ¬¡

- then æ–¹æ³•å¿…é¡»è¿”å›ä¸€ä¸ª promise å¯¹è±¡

### Then å‚æ•° (å‡½æ•°) è¿”å›å€¼

å¸Œæœ›è¯»è€…å¯ä»¥è®¤çœŸçœ‹è¿™éƒ¨åˆ†çš„å†…å®¹ï¼Œå¯¹äºç†è§£ promise çš„ `then` æ–¹æ³•æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚

å…ˆæ¥çœ‹ä¸‹ promise æ‰§è¡Œè¿‡ç¨‹ï¼š

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/8.png)

å¤§è‡´çš„è¿‡ç¨‹æ˜¯ï¼Œpromise ä¼šä» `pending` è½¬ä¸º `fulfilled` æˆ– `rejected` ï¼Œç„¶åå¯¹åº”è°ƒç”¨ `then` æ–¹æ³•å‚æ•°çš„ `onFulfilled` æˆ– `onRejected` ï¼Œæœ€ç»ˆè¿”å› `promise` å¯¹è±¡ã€‚

è¿›ä¸€æ­¥ç†è§£ï¼Œå‡å®š æœ‰å¦‚ä¸‹ä¸¤ä¸ª promiseï¼š

```js
promise2 = promise1.then(onFulfilled, onRejected);
```

ä¼šæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

1. å¦‚æœ `onFulfilled` æˆ–è€… `onRejected` **æŠ›å‡ºå¼‚å¸¸ e** ï¼Œåˆ™ promise2 **å¿…é¡»æ‹’ç»æ‰§è¡Œ**ï¼Œå¹¶è¿”å› `æ‹’å›  e`

2. å¦‚æœ `onFulfilled` **ä¸æ˜¯å‡½æ•°** ä¸” promise1 æˆåŠŸæ‰§è¡Œï¼Œ promise2 å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å› **ç›¸åŒçš„å€¼**

3. å¦‚æœ `onRejected` **ä¸æ˜¯å‡½æ•°** ä¸” promise1 æ‹’ç»æ‰§è¡Œï¼Œ promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å› **ç›¸åŒçš„æ®å› **

å¸Œæœ›è¿›ä¸€æ­¥ææ‡‚çš„ï¼Œå¯ä»¥å°†ä¸‹é¢ä»£ç æ‹·è´åˆ° chrome æ§åˆ¶å°æˆ–å…¶ä»–å¯æ‰§è¡Œç¯å¢ƒæ„Ÿå—ä¸€ä¸‹ï¼š

```js
// é€šè¿‡æ”¹å˜ isResolve æ¥åˆ‡æ¢ promise1 çš„çŠ¶æ€
const isResolve = true;

const promise1 = new Promise((resolve, reject) => {
  if (isResolve) {
    resolve('promise1 æ‰§è¡Œæ€');
  } else {
    reject('promise1 æ‹’ç»æ€');
  }
});

// ä¸€ã€promise1 å¤„äº resolve ä»¥åŠ onFulfilled æŠ›å‡ºå¼‚å¸¸ çš„æƒ…å†µ
// promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œï¼Œå¹¶è¿”å›æ‹’å› 
promise1
  .then(() => {
    throw 'æŠ›å‡ºå¼‚å¸¸!';
  })
  .then(
    value => {
      console.log(value);
    },
    reason => {
      console.log(reason);
    }
  );

// äºŒã€promise1 å¤„äº resolve ä»¥åŠ onFulfilled ä¸æ˜¯å‡½æ•°çš„æƒ…å†µ
// promise2 å¿…é¡»æˆåŠŸæ‰§è¡Œå¹¶è¿”å›ç›¸åŒçš„å€¼
promise1.then().then(value => {
  console.log(value);
});

// ä¸‰ã€promise1 å¤„äº reject ä»¥åŠ onRejected ä¸æ˜¯å‡½æ•°çš„æƒ…å†µ
// promise2 å¿…é¡»æ‹’ç»æ‰§è¡Œå¹¶è¿”å›æ‹’å› 
promise1.then().then(
  () => {},
  reason => {
    console.log(reason);
  }
);

// å››ã€promise1 å¤„äº resolve ä»¥åŠ onFulfilled æœ‰è¿”å›å€¼æ—¶
promise1
  .then(value => {
    return value;
  })
  .then(value => {
    console.log(value);
  });
```

ä¸‹é¢è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æƒ…å†µï¼Œå®ƒå…³ç³»åˆ°ä¸šåŠ¡åœºæ™¯ä¸­ä¼ å€¼é—®é¢˜ï¼š

4. `onFulfilled` æˆ–è€… `onRejected` è¿”å› **ä¸€ä¸ª JavaScript åˆæ³•å€¼** çš„æƒ…å†µ

æˆ‘ä»¬å…ˆæ¥å‡å®š then æ–¹æ³•å†…éƒ¨æœ‰ä¸€ä¸ªå«åš `[[Resolve]]` çš„æ–¹æ³•ç”¨äºå¤„ç†è¿™ç§ç‰¹æ®Šæƒ…å†µï¼Œä¸‹é¢æ¥å…·ä½“äº†è§£ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚

### `[[Resolve]]` æ–¹æ³•

ä¸€èˆ¬åƒ `[[...]]` è¿™æ ·çš„è®¤ä¸ºæ˜¯å†…éƒ¨å®ç°ï¼Œå¦‚ `[[Resolve]]`ï¼Œè¯¥æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼š

```js
[[Resolve]](promise, x);
```

å¯¹äº `x` å€¼ï¼Œæœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š

- `x` æœ‰ **then æ–¹æ³•** ä¸”çœ‹ä¸Šå»åƒä¸€ä¸ª `Promise`

- `x` ä¸ºå¯¹è±¡æˆ–å‡½æ•°

- `x` ä¸º `Promise`

å¦å¤– promise ä¸èƒ½ä¸ x ç›¸ç­‰å³ `promise !== x`,å¦åˆ™ï¼š

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/same.png)

ä¸‹é¢æ¥çœ‹å¼ å›¾ï¼Œå¤§è‡´äº†è§£ä¸‹å„æƒ…å†µçš„åº”å¯¹æ–¹å¼ï¼š

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/resolve.png)

### `Promise/A+` å°ç»“

è‡³æ­¤ï¼Œ`Promise/A+` éœ€è¦ äº†è§£çš„å°±è®²å®Œäº†ã€‚ä¸»è¦åŒ…æ‹¬äº†ï¼Œæœ¯è¯­ä»¥åŠ Then æ–¹æ³•çš„ç”¨æ³•å’Œç›¸å…³æ³¨æ„äº‹é¡¹ã€‚éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œthen æ–¹æ³•ä¸­å‚æ•°è¿”å›å€¼çš„å¤„ç†ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åœ¨è§„èŒƒçš„åŸºç¡€ä¸Šï¼Œç”¨ TypeScript æ¥ å®ç° Promiseã€‚

**æ¥ä¸‹æ¥ï¼Œæ–‡ä¸­å‡ºç°çš„è§„èŒƒç‰¹æŒ‡ `Promise/A+` è§„èŒƒ**

## Promise å®ç°

Promise æœ¬èº«æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå³å¯ä»¥å®ç°ä¸ºç±»ã€‚æ¥ä¸‹æ¥ï¼Œä¸»è¦å›´ç»•å®ç°ä¸€ä¸ª Promise ç±»æ¥è®²ã€‚

å…ˆæ¥çœ‹ä¸‹ä¸€ä¸ªæ ‡å‡† promise å¯¹è±¡å…·å¤‡çš„å±æ€§å’Œ æ–¹æ³•ï¼Œåšåˆ°å¿ƒä¸­æœ‰æ•°ã€‚

Promise æä¾›çš„ APIï¼š

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/3.png)

Promise å†…éƒ¨å±æ€§åŒ…æ‹¬ï¼š

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/2.png)

ä¸‹é¢å¼€å§‹æ­£å¼çš„å®ç°éƒ¨åˆ†

### å£°æ˜æ–‡ä»¶

åœ¨å¼€å§‹å‰ï¼Œå…ˆæ¥äº†è§£ä¸‹ï¼Œç”¨ TypeScript å†™ Promise æ¶‰åŠçš„ä¸€äº›ç±»å‹å£°æ˜ã€‚å¯ä»¥çœ‹è¿™ä¸ª[å£°æ˜æ–‡ä»¶](https://github.com/leer0911/myPromise/blob/master/index.d.ts)ã€‚

ä¸»è¦åŒ…æ‹¬ï¼š

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/4.png)

TypeScript ä¸­å£°æ˜æ–‡ä»¶ç”¨äºå¤–éƒ¨æ¨¡å—ï¼Œæ˜¯ TypeScript çš„æ ¸å¿ƒéƒ¨åˆ†ã€‚å¦å¤–ï¼Œä»ä¸€ä¸ªå£°æ˜æ–‡ä»¶å°±å¯ä»¥å¤§è‡´äº†è§£æ‰€ç”¨æ¨¡å—æš´éœ²çš„ API æƒ…å†µ (æ¥å—ä»€ä¹ˆç±»å‹ï¼Œæˆ–è€…ä¼šè¿”å›ä»€ä¹ˆç±»å‹çš„æ•°æ®)ã€‚è¿™ç§äº‹å…ˆè®¾è®¡å¥½ API æ˜¯ä¸€ä¸ªå¥½çš„å¼€å‘ä¹ æƒ¯ï¼Œä½†å®é™…å¼€å‘ä¸­ä¼šæ¯”è¾ƒéš¾ã€‚

æ¥ç€æ¥çœ‹ï¼ŒPromise ç±»æ ¸å¿ƒå®ç°çš„å¼€å§‹éƒ¨åˆ†ï¼Œæ„é€ å‡½æ•°ã€‚

### æ„é€ å‡½æ•°

è§„èŒƒæåˆ° Promise æ„é€ å‡½æ•°æ¥å—ä¸€ä¸ª `Resolver` ç±»å‹çš„å‡½æ•°ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•° resolve å’Œ rejectï¼Œç”¨äºå¤„ç† promise çŠ¶æ€ã€‚

å®ç°å¦‚ä¸‹ï¼š

```ts
class Promise {
  // å†…éƒ¨å±æ€§
  private ['[[PromiseStatus]]']: PromiseStatus = 'pending';
  private ['[[PromiseValue]]']: any = undefined;

  subscribes: any[] = [];

  constructor(resolver: Resolver<R>) {
    this[PROMISE_ID] = id++;
    // resolver å¿…é¡»ä¸ºå‡½æ•°
    typeof resolver !== 'function' && resolverError();
    // ä½¿ç”¨ Promise æ„é€ å‡½æ•°ï¼Œéœ€è¦ç”¨ new æ“ä½œç¬¦
    this instanceof Promise ? this.init(resolver) : constructorError();
  }

  private init(resolver: Resolver<R>) {
    try {
      // ä¼ å…¥ä¸¤ä¸ªå‚æ•°å¹¶è·å–ç”¨æˆ·ä¼ å…¥çš„ç»ˆå€¼æˆ–æ‹’å› ã€‚
      resolver(
        value => {
          this.mockResolve(value);
        },
        reason => {
          this.mockReject(reason);
        }
      );
    } catch (e) {
      this.mockReject(e);
    }
    return null;
  }

  private mockResolve() {
    // TODO
  }
  private mockReject() {
    // TODO
  }
}
```

### [[Resolve]] å®ç°

é€šè¿‡å‰é¢è§„èŒƒéƒ¨åˆ†ï¼Œæˆ‘ä»¬äº†è§£åˆ° `[[Resolve]]` å±äºå†…éƒ¨å®ç°ï¼Œç”¨äºå¤„ç† then å‚æ•°çš„è¿”å›å€¼ã€‚ä¹Ÿå°±æ˜¯è¿™é‡Œå³å°†è¦å®ç°çš„åä¸º `mockResolve` çš„æ–¹æ³•ã€‚

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/5.png)

æ ¹æ®è§„èŒƒå†…å®¹å¯ä»¥å¾—çŸ¥ï¼Œ`mockResolve` æ–¹æ³•æ¥å—çš„ value å¯èƒ½ä¸º Promiseï¼Œthenableï¼Œä»¥åŠå…¶ä»–æœ‰æ•ˆ JavaScript å€¼ã€‚

```ts
private mockResolve(value: any) {
  // è§„èŒƒæåˆ° resolve ä¸èƒ½ä¼ å…¥å½“å‰è¿”å›çš„ promise
  // å³ `[[Resolve]](promise,x)` ä¸­ promise ï¼== x
  if (value === this) {
    this.mockReject(resolveSelfError);
    return;
  }
  // éå¯¹è±¡å’Œå‡½æ•°ï¼Œç›´æ¥å¤„ç†
  if (!isObjectORFunction(value)) {
    this.fulfill(value);
    return;
  }
  // å¤„ç†ä¸€äº›åƒ promise çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œå³ thenable
  this.handleLikeThenable(value, this.getThen(value));
}
```

#### å¤„ç† Thenable å¯¹è±¡

é‡ç‚¹çœ‹ä¸‹ `handleLikeThenable` å®ç°ï¼Œå¯ç»“åˆå‰é¢è§„èŒƒéƒ¨åˆ†æåŠ Thenable çš„å‡ ç§æƒ…å†µæ¥åˆ†æï¼š

```ts
  private handleLikeThenable(value: any, then: any) {
    // å¤„ç† "çœŸå®" promise å¯¹è±¡
    if (this.isThenable(value, then)) {
      this.handleOwnThenable(value);
      return;
    }
    // è·å– then å€¼å¤±è´¥ä¸”æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™ä»¥æ­¤å¼‚å¸¸ä¸ºæ‹’å›  reject promise
    if (then === TRY_CATCH_ERROR) {
      this.mockReject(TRY_CATCH_ERROR.error);
      TRY_CATCH_ERROR.error = null;
      return;
    }
    // å¦‚æœ then æ˜¯å‡½æ•°ï¼Œåˆ™æ£€éªŒ then æ–¹æ³•çš„åˆæ³•æ€§
    if (isFunction(then)) {
      this.handleForeignThenable(value, then);
      return;
    }
    // é Thenable ï¼Œåˆ™å°†è¯¥ç»ˆæ¤ç›´æ¥äº¤ç”± fulfill å¤„ç†
    this.fulfill(value);
  }
```

#### å¤„ç† Thenable ä¸­ Then ä¸ºå‡½æ•°çš„æƒ…å†µ

è§„èŒƒæåŠï¼š

> å¦‚æœ then æ˜¯å‡½æ•°ï¼Œå°† x ä½œä¸ºå‡½æ•°çš„ä½œç”¨åŸŸ this è°ƒç”¨ä¹‹ã€‚ä¼ é€’ä¸¤ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å«åš resolvePromise ï¼Œç¬¬äºŒä¸ªå‚æ•°å«åš rejectPromiseã€‚

æ­¤æ—¶ï¼Œ`handleForeignThenable` å°±æ˜¯ç”¨æ¥æ£€éªŒ then æ–¹æ³•çš„ã€‚

å®ç°å¦‚ä¸‹ï¼š

```ts
  private tryThen(then, thenable, resolvePromise, rejectPromise) {
    try {
      then.call(thenable, resolvePromise, rejectPromise);
    } catch (e) {
      return e;
    }
  }
  private handleForeignThenable(thenable: any, then: any) {
    this.asap(() => {
      // å¦‚æœ resolvePromise å’Œ rejectPromise å‡è¢«è°ƒç”¨ï¼Œ
      // æˆ–è€…è¢«åŒä¸€å‚æ•°è°ƒç”¨äº†å¤šæ¬¡ï¼Œåˆ™ä¼˜å…ˆé‡‡ç”¨é¦–æ¬¡è°ƒç”¨å¹¶å¿½ç•¥å‰©ä¸‹çš„è°ƒç”¨
      // æ­¤å¤„ sealed (ç¨³å®šå¦)ï¼Œç”¨äºå¤„ç†ä¸Šè¯‰é€»è¾‘
      let sealed = false;
      const error = this.tryThen(
        then,
        thenable,
        value => {
          if (sealed) {
            return;
          }
          sealed = true;
          if (thenable !== value) {
            this.mockResolve(value);
          } else {
            this.fulfill(value);
          }
        },
        reason => {
          if (sealed) {
            return;
          }
          sealed = true;
          this.mockReject(reason);
        }
      );

      if (!sealed && error) {
        sealed = true;
        this.mockReject(error);
      }
    });
  }
```

#### fulfill å®ç°

æ¥çœ‹ `[[Resolve]]` ä¸­æœ€åä¸€æ­¥ï¼Œ`fulfill` å®ç°ï¼š

```ts
  private fulfill(value: any) {
    this['[[PromiseStatus]]'] = 'fulfilled';
    this['[[PromiseValue]]'] = value;

    // ç”¨äºå¤„ç†å¼‚æ­¥æƒ…å†µ
    if (this.subscribes.length !== 0) {
      this.asap(this.publish);
    }
  }
```

çœ‹åˆ°è¿™é‡Œï¼Œå¤§å®¶å¯èƒ½æœ‰å…³æ³¨åˆ°å¾ˆå¤šæ–¹æ³•éƒ½å¸¦æœ‰ `private` ä¿®é¥°ç¬¦ï¼Œåœ¨ TypeScript ä¸­

> private ä¿®é¥°çš„å±æ€§æˆ–æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œä¸èƒ½åœ¨å£°æ˜å®ƒçš„ç±»çš„å¤–éƒ¨è®¿é—®

è§„èŒƒæåˆ°è¿‡ï¼Œ`PromiseStatus` å±æ€§ä¸èƒ½ç”±å¤–éƒ¨æ›´æ”¹ï¼Œä¹Ÿå°±æ˜¯ promise çŠ¶æ€åªèƒ½æ”¹å˜ä¸€æ¬¡ï¼Œè€Œä¸”åªèƒ½ä»å†…éƒ¨æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œç§æœ‰æ–¹æ³• `fulfill` çš„èŒè´£æ‰€åœ¨ã€‚

#### `[[Resolve]]` å°ç»“

è‡³æ­¤ï¼Œä¸€ä¸ªå†…éƒ¨ `[[Resolve]]` å°±å®ç°äº†ã€‚æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ï¼Œ`[[Resolve]]` ç”¨äºå¤„ç†ä»¥ä¸‹æƒ…å†µ

```ts
// å®ä¾‹åŒ–æ„é€ å‡½æ•°ï¼Œä¼ å…¥ resolve çš„æƒ…å†µ
const promise = Promise(resolve => {
  const value: any;
  resolve(value);
});
```

ä»¥åŠ

```ts
// then æ–¹æ³•ä¸­æœ‰ è¿”å›å€¼çš„æƒ…å†µ
promise.then(
  () => {
    const value: any;
    return value;
  },
  () => {
    const reason: any;
    return reason;
  }
);
```

å¯¹äºç»ˆå€¼ `value` æœ‰å¤šç§æƒ…å†µï¼Œåœ¨å¤„ç† Thenable çš„æ—¶å€™ï¼Œè¯·å‚è€ƒè§„èŒƒæ¥å®ç°ã€‚`promise` é™¤äº† `resolve` çš„è¿˜æœ‰ `reject`ï¼Œä½†è¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬ä¼šæ”¾åˆ°åé¢å†è®²è§£ã€‚å…ˆæ¥çœ‹ä¸ `resolve` å¯†ä¸å¯åˆ†çš„ `then` æ–¹æ³•å®ç°ã€‚è¿™ä¹Ÿæ˜¯ `promise` çš„æ ¸å¿ƒæ–¹æ³•ã€‚

### Then æ–¹æ³•å®ç°

é€šè¿‡å‰é¢çš„å®ç°ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä» Promise æ„é€ å‡½æ•°æ¥æ”¹å˜å†…éƒ¨ `[[PromiseStatus]]` çŠ¶æ€ä»¥åŠå†…éƒ¨ `[[PromiseValue]]` å€¼ï¼Œå¹¶ä¸”å¯¹äºå¤šç§ value å€¼æˆ‘ä»¬éƒ½æœ‰åšç›¸åº”çš„å…¼å®¹å¤„ç†ã€‚æ¥ä¸‹æ¥ï¼Œæ˜¯æ—¶å€™æŠŠè¿™äº›å€¼äº¤ç”± then æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•° `onFulfilled` å¤„ç†äº†ã€‚

åœ¨è®²è§£ä¹‹å‰å…ˆæ¥çœ‹ä¸‹è¿™ç§æƒ…å†µï¼š

```ts
promise2 = promise1.then(onFulfilled, onRejected);
```

ä½¿ç”¨ `promise1` çš„ `then` æ–¹æ³•åï¼Œä¼šè¿”å›ä¸€ä¸ª promise å¯¹è±¡ `promise2` å®ç°å¦‚ä¸‹ï¼š

```ts
class Promise {
  then(onFulfilled?, onRejected?) {
    // å¯¹åº”ä¸Šè¿°çš„ promise1
    const parent: any = this;
    // å¯¹åº”ä¸Šè¿°çš„ promise2
    const child = new parent.constructor(() => {});

    // æ ¹æ® promise çš„çŠ¶æ€é€‰æ‹©å¤„ç†æ–¹å¼
    const state = PROMISE_STATUS[this['[[PromiseStatus]]']];
    if (state) {
      // promise å„çŠ¶æ€å¯¹åº”æšä¸¾å€¼ 'pending' å¯¹åº” 0 ï¼Œ'fulfilled' å¯¹åº” 1ï¼Œ'rejected' å¯¹åº” 2
      const callback = arguments[state - 1];
      this.asap(() =>
        this.invokeCallback(
          this['[[PromiseStatus]]'],
          child,
          callback,
          this['[[PromiseValue]]']
        )
      );
    } else {
      // è°ƒç”¨ then æ–¹æ³•çš„ promise å¤„äº pending çŠ¶æ€çš„å¤„ç†é€»è¾‘ï¼Œä¸€èˆ¬ä¸ºå¼‚æ­¥æƒ…å†µã€‚
      this.subscribe(parent, child, onFulfilled, onRejected);
    }

    // è¿”å›ä¸€ä¸ª promise å¯¹è±¡
    return child;
  }
}
```

è¿™é‡Œæ¯”è¾ƒæƒ¹çœ¼çš„ `asap` åç»­ä¼šå•ç‹¬è®²ã€‚å…ˆæ¥ç†é¡ºä¸€ä¸‹é€»è¾‘ï¼Œ`then` æ–¹æ³•æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç”±å½“å‰ `promise` çš„çŠ¶æ€å†³å®šè°ƒç”¨ `onFulfilled` è¿˜æ˜¯ `onRejected`ã€‚

ç°åœ¨å¤§å®¶è‚¯å®šå¾ˆå…³å¿ƒ then æ–¹æ³•é‡Œçš„ä»£ç æ˜¯å¦‚ä½•è¢«æ‰§è¡Œçš„ï¼Œæ¯”å¦‚ä¸‹é¢çš„ `console.log`ï¼š

```ts
promise.then(value => {
  console.log(value);
});
```

æ¥ä¸‹æ¥çœ‹ä¸ä¹‹ç›¸å…³çš„ `invokeCallback` æ–¹æ³•

### then æ–¹æ³•ä¸­å›è°ƒå¤„ç†

then æ–¹æ³•ä¸­çš„ `onFulfilled` å’Œ `onRejected` éƒ½æ˜¯å¯é€‰å‚æ•°ï¼Œå¼€å§‹è¿›ä¸€æ­¥è®²è§£å‰ï¼Œå»ºè®®å¤§å®¶å…ˆäº†è§£è§„èŒƒä¸­æåŠçš„ä¸¤ä¸ªå‚æ•°çš„ç‰¹æ€§ã€‚

ç°åœ¨æ¥è®²è§£ `invokeCallback` æ¥å—çš„å‚æ•°åŠå…¶å«ä¹‰ï¼š

- `settled` (**ç¨³å®šçŠ¶æ€**)ï¼Œpromise å¤„äº**é pending** çŠ¶æ€åˆ™ç§°ä¹‹ä¸º settledï¼Œsettled çš„å€¼å¯ä»¥ä¸º `fulfilled` æˆ– `rejected`

- `child` å³å°†è¿”å›çš„ promise å¯¹è±¡

- `callback` æ ¹æ® `settled` é€‰æ‹©çš„ `onFulfilled` æˆ– `onRejected` å›è°ƒå‡½æ•°

- `detail` å½“å‰è°ƒç”¨ then æ–¹æ³• promise çš„ value(ç»ˆå€¼) æˆ– reason(æ‹’å› )

**æ³¨æ„è¿™é‡Œçš„ `settled` å’Œ `detail`ï¼Œ`settled` ç”¨äºæŒ‡ `fulfilled` æˆ– `rejected`ï¼Œ detail ç”¨äºæŒ‡ `value` æˆ– `reason` è¿™éƒ½æ˜¯æœ‰å«ä¹‰çš„**

çŸ¥é“è¿™äº›ä¹‹åï¼Œå°±åªéœ€è¦å‚è€ƒè§„èŒƒå»ºè®®å®ç°çš„æ–¹å¼è¿›è¡Œå¤„ç†ç›¸åº”ï¼š

```ts
  private invokeCallback(settled, child, callback, detail) {
    // 1ã€æ˜¯å¦æœ‰ callback çš„å¯¹åº”é€»è¾‘å¤„ç†
    // 2ã€å›è°ƒå‡½æ•°æ‰§è¡Œåæ˜¯å¦ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå³ç›¸åº”å¤„ç†
    // 3ã€è¿”å›å€¼ä¸èƒ½ä¸ºè‡ªå·±çš„é€»è¾‘å¤„ç†
    // 4ã€promise ç»“æŸ(æ‰§è¡Œç»“æŸæˆ–è¢«æ‹’ç»)å‰ä¸èƒ½æ‰§è¡Œå›è°ƒçš„é€»è¾‘å¤„ç†
    // ...
  }
```

éœ€è¦å¤„ç†çš„é€»è¾‘å·²ç»™å‡ºï¼Œå‰©ä¸‹çš„å®ç°æ–¹å¼è¯»è€…å¯è‡ªè¡Œå®ç°æˆ–çœ‹æœ¬é¡¹ç›®æºç å®ç°ã€‚å»ºè®®æ‰€æœ‰å®ç°éƒ½åº”å‚è€ƒè§„èŒƒæ¥è½å®ï¼Œåœ¨å®ç°è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°é—æ¼æˆ–é”™è¯¯å¤„ç†çš„æƒ…å†µã€‚(**psï¼šè€ƒéªŒä¸€ä¸ªä¾èµ–å¥å£®æ€§çš„æ—¶å€™åˆ°äº†**)

æˆªè‡³ç›®å‰ï¼Œéƒ½æ˜¯å¤„ç†åŒæ­¥çš„æƒ…å†µã€‚promise å·ç§°å¤„ç†å¼‚æ­¥çš„å¤§ç¥ï¼Œæ€ä¹ˆèƒ½å°‘å¾—äº†ç›¸åº”å®ç°ã€‚å¤„ç†å¼‚æ­¥çš„æ–¹å¼æœ‰å›è°ƒå’Œè®¢é˜…å‘å¸ƒæ¨¡å¼ï¼Œæˆ‘ä»¬å®ç° promise å°±æ˜¯ä¸ºäº†è§£å†³å›è°ƒåœ°ç‹±çš„ï¼Œæ‰€ä»¥è¿™é‡Œå½“ç„¶é€‰æ‹©ä½¿ç”¨ è®¢é˜…å‘å¸ƒæ¨¡å¼ã€‚

### then å¼‚æ­¥å¤„ç†

è¿™é‡Œè¦å¤„ç†çš„æƒ…å†µæ˜¯æŒ‡ï¼šå½“è°ƒç”¨ then æ–¹æ³•çš„ promise å¤„äº pending çŠ¶æ€æ—¶ã€‚

é‚£ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°è¿™ç§æƒ…å†µå‘¢ï¼Ÿæ¥çœ‹ä¸‹è¿™æ®µä»£ç ï¼š

```ts
const promise = new Promise(resolve => {
  setTimeout(() => {
    resolve(1);
  }, 1000);
});

promise.then(value => {
  console.log(value);
});
```

ä»£ç ç¼–å†™åˆ°è¿™é‡Œï¼Œå¦‚æœå‡ºç°è¿™ç§æƒ…å†µã€‚æˆ‘ä»¬çš„ promise å…¶å®æ˜¯ä¸èƒ½æ­£å¸¸å·¥ä½œçš„ã€‚ç”±äº `setTimeout` æ˜¯ä¸€ä¸ªå¼‚å¸¸æ“ä½œï¼Œå½“å†…éƒ¨ then æ–¹æ³•æŒ‰åŒæ­¥æ‰§è¡Œçš„æ—¶å€™ï¼Œresolve æ ¹æœ¬æ²¡æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´è°ƒç”¨ then æ–¹æ³•çš„ promise çš„ `[[PromiseStatus]]` ç›®å‰è¿˜å¤„äº 'pending'ï¼Œ`[[PromiseValue]]` ç›®å‰ä¸º undefinedï¼Œæ­¤æ—¶æ·»åŠ å¯¹ `pending` çŠ¶æ€ä¸‹çš„å›è°ƒæ˜¯æ²¡æœ‰ä»»ä½•æ„ä¹‰çš„ ï¼Œå¦å¤–è§„èŒƒæåŠ then æ–¹æ³•çš„å›è°ƒå¿…é¡»å¤„äº settled( **ä¹‹å‰æœ‰è®²è¿‡** ) æ‰ä¼šè°ƒç”¨ç›¸åº”å›è°ƒã€‚

æˆ–è€…æˆ‘ä»¬ä¸ç”¨è€ƒè™‘æ˜¯ä¸æ˜¯å¼‚æ­¥é€ æˆçš„ï¼Œåªéœ€è¦æ˜ç¡®ä¸€ä»¶äº‹ã€‚å­˜åœ¨è¿™ä¹ˆä¸€ç§æƒ…å†µï¼Œè°ƒç”¨ then æ–¹æ³•çš„ promise çŠ¶æ€å¯èƒ½ä¸º`pending`ã€‚

è¿™æ—¶å°±å¿…é¡»æœ‰ä¸€å¥—æœºåˆ¶æ¥å¤„ç†è¿™ç§æƒ…å†µï¼Œå¯¹åº”ä»£ç å®ç°å°±æ˜¯ï¼š

```ts
  private subscribe(parent, child, onFulfillment, onRejection) {
    let {
      subscribes,
      subscribes: { length }
    } = parent;
    subscribes[length] = child;
    subscribes[length + PROMISE_STATUS.fulfilled] = onFulfillment;
    subscribes[length + PROMISE_STATUS.rejected] = onRejection;
    if (length === 0 && PROMISE_STATUS[parent['[[PromiseStatus]]']]) {
      this.asap(this.publish);
    }
  }
```

`subscribe` æ¥å— 4 ä¸ªå‚æ•° `parent`ï¼Œ`child`,`onFulfillment`,`onRejection`

- `parent` ä¸ºå½“å‰è°ƒç”¨ then æ–¹æ³•çš„ promise å¯¹è±¡
- `child` ä¸ºå³å°†ç”± then æ–¹æ³•è¿”å›çš„ promise å¯¹è±¡
- `onFulfillment` then æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°
- `onFulfillment` then æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•°

ç”¨ä¸€ä¸ªæ•°ç»„æ¥å­˜å‚¨ `subscribe` ï¼Œä¸»è¦ä¿å­˜å³å°†è¿”å›çš„ promise å¯¹è±¡åŠç›¸åº”çš„ `onFulfillment` å’Œ `onRejection` å›è°ƒå‡½æ•°ã€‚

æ»¡è¶³ `subscribe` æ˜¯æ–°å¢çš„æƒ…å†µåŠè°ƒç”¨ then æ–¹æ³•çš„ promise å¯¹è±¡çš„ `[[PromiseStatus]]` å€¼ä¸ä¸º 'pending'ï¼Œåˆ™è°ƒç”¨ `publish` æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´å¼‚æ­¥çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šè°ƒç”¨è¯¥ `publish` æ–¹æ³•ã€‚
è¿™ä¹ˆçœ‹æ¥è¿™ä¸ª `publish` æ˜¯è·Ÿæ‰§è¡Œå›è°ƒç›¸å…³çš„æ–¹æ³•ã€‚

é‚£å¼‚æ­¥çš„æƒ…å†µï¼Œä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘å›è°ƒå‘¢?å¯ä»¥å›é¡¾ä¹‹å‰è®²è§£è¿‡çš„ `fulfill` æ–¹æ³•:

```ts
  private fulfill(value: any) {
    this['[[PromiseStatus]]'] = 'fulfilled';
    this['[[PromiseValue]]'] = value;

    // ç”¨äºå¤„ç†å¼‚æ­¥æƒ…å†µ
    if (this.subscribes.length !== 0) {
      this.asap(this.publish);
    }
  }
```

å½“æ»¡è¶³ `this.subscribes.length !== 0` æ—¶ä¼šè§¦å‘ `publish`ã€‚ä¹Ÿå°±æ˜¯è¯´å½“å¼‚æ­¥å‡½æ•°æ‰§è¡Œå®Œæˆåè°ƒç”¨ `resolve` æ–¹æ³•æ—¶ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªæ˜¯å¦è°ƒç”¨ `subscribes` é‡Œé¢çš„å›è°ƒå‡½æ•°çš„åˆ¤æ–­ã€‚

è¿™æ ·å°±ä¿è¯äº† `then` æ–¹æ³•é‡Œå›è°ƒå‡½æ•°åªä¼šåœ¨å¼‚æ­¥å‡½æ•°æ‰§è¡Œå®Œæˆåè§¦å‘ã€‚æ¥ç€æ¥çœ‹ä¸‹ä¸ä¹‹ç›¸å…³çš„ `publish` æ–¹æ³•

### publish æ–¹æ³•

é¦–å…ˆæ˜ç¡®ï¼Œ`publish` æ˜¯å‘å¸ƒï¼Œæ˜¯é€šè¿‡ `invokeCallback` æ¥è°ƒç”¨å›è°ƒå‡½æ•°çš„ã€‚åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œåªä¸ `subscribes` æœ‰å…³ã€‚ç›´æ¥æ¥çœ‹ä¸‹ä»£ç ï¼š

```ts
  private publish() {
    const subscribes = this.subscribes;
    const state = this['[[PromiseStatus]]'];
    const settled = PROMISE_STATUS[state];
    const result = this['[[PromiseValue]]'];
    if (subscribes.length === 0) {
      return;
    }
    for (let i = 0; i < subscribes.length; i += 3) {
      // å³å°†è¿”å›çš„ promise å¯¹è±¡
      const item = subscribes[i];
      const callback = subscribes[i + settled];
      if (item) {
        this.invokeCallback(state, item, callback, result);
      } else {
        callback(result);
      }
    }
    this.subscribes.length = 0;
  }
```

### then æ–¹æ³•å°ç»“

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/6.png)

åˆ°è¿™æˆ‘ä»¬å°±å®ç°äº† promise ä¸­çš„ then æ–¹æ³•ï¼Œä¹Ÿå°±æ„å‘³ç€ç›®å‰å®ç°çš„ promise å·²ç»å…·å¤‡å¤„ç†å¼‚æ­¥æ•°æ®æµçš„èƒ½åŠ›äº†ã€‚then æ–¹æ³•çš„å®ç°ç¦»ä¸å¼€è§„èŒƒçš„æŒ‡å¼•ï¼Œåªè¦å‚è€ƒè§„èŒƒå¯¹ then æ–¹æ³•çš„æè¿°ï¼Œå…¶ä½™å°±åªæ˜¯é€»è¾‘å¤„ç†äº†ã€‚

è‡³æ­¤ promise çš„æ ¸å¿ƒåŠŸèƒ½å·²ç»è®²å®Œäº†ï¼Œä¹Ÿå°±æ˜¯å†…éƒ¨ `[[Resolve]]` å’Œ `then` æ–¹æ³•ã€‚æ¥ä¸‹æ¥å¿«é€Ÿçœ‹ä¸‹å…¶ä½™ APIã€‚

## è¯­æ³•ç³– API å®ç°

catch å’Œ finally éƒ½å±äºè¯­æ³•ç³–

- `catch` å±äº `this.then(null, onRejection)`

- `finally` å±äº `this.then(callback, callback);`

promise è¿˜æä¾›äº† `resolve`ï¼Œ`reject`ï¼Œ`all`ï¼Œ`race` çš„é™æ€æ–¹æ³•ï¼Œä¸ºäº†æ–¹ä¾¿é“¾å¼è°ƒç”¨ï¼Œä¸Šè¿°æ–¹æ³•å‡ä¼šè¿”å›ä¸€ä¸ªæ–°çš„ promise å¯¹è±¡ç”¨äºé“¾å¼è°ƒç”¨ã€‚

ä¹‹å‰ä¸»è¦è®² `resolve`ï¼Œç°åœ¨æ¥çœ‹ä¸‹

### reject

`reject` å¤„ç†æ–¹å¼è·Ÿ `resolve` ç•¥å¾®ä¸åŒçš„æ˜¯å®ƒä¸ç”¨å¤„ç† thenable çš„æƒ…å†µï¼Œè§„åˆ™æåŠ reject çš„å€¼ reason å»ºè®®ä¸º error å®ä¾‹ä»£ç å®ç°å¦‚ä¸‹ï¼š

```ts
  private mockReject(reason: any) {
    this['[[PromiseStatus]]'] = 'rejected';
    this['[[PromiseValue]]'] = reason;
    this.asap(this.publish);
  }
  static reject(reason: any) {
    let Constructor = this;
    let promise = new Constructor(() => {});
    promise.mockReject(reason);
    return promise;
  }
  private mockReject(reason: any) {
    this['[[PromiseStatus]]'] = 'rejected';
    this['[[PromiseValue]]'] = reason;
    this.asap(this.publish);
  }
```

### all & race

åœ¨å‰é¢ API çš„åŸºç¡€ä¸Šï¼Œæ‰©å±•å‡º all å’Œ race å¹¶ä¸éš¾ã€‚å…ˆæ¥çœ‹ä¸¤è€…çš„ä½œç”¨ï¼š

- all ç”¨äºå¤„ç†ä¸€ç»„ promiseï¼Œå½“æ»¡è¶³æ‰€æœ‰ promise éƒ½ resolve æˆ– æŸä¸ª promise reject æ—¶è¿”å›å¯¹åº”ç”± value ç»„æˆçš„æ•°ç»„æˆ– reject çš„ reason

- race èµ›è·‘çš„æ„æ€ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€ç»„ promise ä¸­çœ‹è°æ‰§è¡Œçš„å¿«ï¼Œåˆ™ç”¨è¿™ä¸ª promise çš„ç»“æœ

å¯¹åº”å®ç°ä»£ç ï¼š

```ts
// all
let result = [];
let num = 0;
return new this((resolve, reject) => {
  entries.forEach(item => {
    this.resolve(item).then(data => {
      result.push(data);
      num++;
      if (num === entries.length) {
        resolve(result);
      }
    }, reject);
  });
});

// race
return new this((resolve, reject) => {
  let length = entries.length;
  for (let i = 0; i < length; i++) {
    this.resolve(entries[i]).then(resolve, reject);
  }
});
```

### æ—¶åºç»„åˆ

å¦‚æœæœ‰éœ€è¦æŒ‰é¡ºåºæ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°ï¼Œå¯ä»¥é‡‡ç”¨å¦‚ä¸‹æ–¹å¼ï¼š

```ts
[func1, func2].reduce((p, f) => p.then(f), Promise.resolve());
```

åœ¨ ES7 ä¸­æ—¶åºç»„åˆå¯ä»¥é€šè¿‡ä½¿ç”¨ `async/await` å®ç°

```ts
for (let f of [func1, func2]) {
  await f();
}
```

æ›´å¤šä½¿ç”¨æ–¹å¼å¯å‚è€ƒ [è¿™ç¯‡](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Using_promises)

## çŸ¥è¯†è¡¥å……

Promise çš„å‡ºç°æ˜¯ä¸ºäº†æ›´å¥½åœ°å¤„ç†å¼‚æ­¥æ•°æ®æµï¼Œæˆ–è€…å¸¸è¯´çš„å›è°ƒåœ°ç‹±ã€‚è¿™é‡Œè¯´çš„å›è°ƒï¼Œæ˜¯åœ¨å¼‚æ­¥çš„æƒ…å†µä¸‹ï¼Œå¦‚æœéå¼‚æ­¥ï¼Œåˆ™ä¸€èˆ¬ä¸éœ€è¦ç”¨åˆ°å›è°ƒå‡½æ•°ã€‚ä¸‹é¢æ¥äº†è§£ä¸‹åœ¨å®ç° Promise è¿‡ç¨‹ä¸­å‡ºç°çš„å‡ ä¸ªæ¦‚å¿µï¼š

- å›è°ƒå‡½æ•°

- å¼‚æ­¥ & åŒæ­¥

- EventLoop

- asap

### å›è°ƒå‡½æ•°

å›è°ƒå‡½æ•°çš„è‹±æ–‡å®šä¹‰ï¼š

> A callback is a function that is passed as an argument to another function and is executed after its parent function has completedã€‚

å­—é¢ä¸Šçš„ç†è§£ï¼Œå›è°ƒå‡½æ•°å°±æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œå°†è¿™ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ä¼ åˆ°å¦ä¸€ä¸ªå‡½æ•°é‡Œé¢ï¼Œå½“é‚£ä¸ªå‡½æ•°æ‰§è¡Œå®Œä¹‹åï¼Œå†æ‰§è¡Œä¼ è¿›å»çš„è¿™ä¸ªå‡½æ•°ã€‚è¿™ä¸ªè¿‡ç¨‹å°±å«åšå›è°ƒã€‚

åœ¨ JavaScript ä¸­ï¼Œå›è°ƒå‡½æ•°å…·ä½“çš„å®šä¹‰ä¸ºï¼š å‡½æ•° A ä½œä¸ºå‚æ•°(å‡½æ•°å¼•ç”¨)ä¼ é€’åˆ°å¦ä¸€ä¸ªå‡½æ•° B ä¸­ï¼Œå¹¶ä¸”è¿™ä¸ªå‡½æ•° B æ‰§è¡Œå‡½æ•° Aã€‚æˆ‘ä»¬å°±è¯´å‡½æ•° A å«åšå›è°ƒå‡½æ•°ã€‚å¦‚æœæ²¡æœ‰åç§°(å‡½æ•°è¡¨è¾¾å¼)ï¼Œå°±å«åšåŒ¿åå›è°ƒå‡½æ•°ã€‚

é¦–å…ˆéœ€è¦å£°æ˜ï¼Œå›è°ƒå‡½æ•°åªæ˜¯ä¸€ç§å®ç°ï¼Œå¹¶ä¸æ˜¯å¼‚æ­¥æ¨¡å¼ç‰¹æœ‰çš„å®ç°ã€‚å›è°ƒå‡½æ•°åŒæ ·å¯ä»¥è¿ç”¨åˆ°åŒæ­¥ï¼ˆé˜»å¡ï¼‰çš„åœºæ™¯ä¸‹ä»¥åŠå…¶ä»–ä¸€äº›åœºæ™¯ã€‚

**å›è°ƒå‡½æ•°éœ€è¦å’Œå¼‚æ­¥å‡½æ•°åŒºåˆ†å¼€æ¥ã€‚**

#### å¼‚æ­¥å‡½æ•° & åŒæ­¥å‡½æ•°

- å¦‚æœåœ¨å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œè°ƒç”¨è€…å°±èƒ½å¤Ÿå¾—åˆ°é¢„æœŸç»“æœï¼Œè¿™ä¸ªå°±æ˜¯åŒæ­¥å‡½æ•°ã€‚

- å¦‚æœåœ¨å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œè°ƒç”¨è€…è¿˜ä¸èƒ½å¤Ÿå¾—åˆ°é¢„æœŸç»“æœï¼Œè€Œæ˜¯éœ€è¦åœ¨å°†æ¥é€šè¿‡ä¸€å®šçš„æ‰‹æ®µå¾—åˆ°ï¼Œé‚£ä¹ˆè¿™ä¸ªå‡½æ•°å°±æ˜¯å¼‚æ­¥çš„ã€‚

é‚£ä»€ä¹ˆæ˜¯å¼‚æ­¥ï¼ŒåŒæ­¥å‘¢?

### å¼‚æ­¥ & åŒæ­¥

é¦–å…ˆè¦æ˜ç¡®ï¼ŒJavascript è¯­è¨€çš„æ‰§è¡Œç¯å¢ƒæ˜¯"å•çº¿ç¨‹"ï¼ˆsingle threadï¼‰ã€‚æ‰€è°“"å•çº¿ç¨‹"ï¼Œå°±æ˜¯æŒ‡ä¸€æ¬¡åªèƒ½å®Œæˆä¸€ä»¶ä»»åŠ¡ã€‚å¦‚æœæœ‰å¤šä¸ªä»»åŠ¡ï¼Œå°±å¿…é¡»æ’é˜Ÿï¼Œå‰é¢ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œå†æ‰§è¡Œåé¢ä¸€ä¸ªä»»åŠ¡ï¼Œä»¥æ­¤ç±»æ¨ã€‚

è¿™ç§æ¨¡å¼ä¼šé€ æˆä¸€ä¸ªé˜»å¡é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavascript è¯­è¨€å°†ä»»åŠ¡çš„æ‰§è¡Œæ¨¡å¼åˆ†æˆä¸¤ç§ï¼šåŒæ­¥ï¼ˆSynchronousï¼‰å’Œå¼‚æ­¥ï¼ˆAsynchronousï¼‰ã€‚

ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼š**å¼‚æ­¥æœºåˆ¶æ˜¯æµè§ˆå™¨çš„ä¸¤ä¸ªæˆ–ä»¥ä¸Šå¸¸é©»çº¿ç¨‹å…±åŒå®Œæˆçš„**ï¼ŒJavascript çš„å•çº¿ç¨‹å’Œå¼‚æ­¥æ›´å¤šçš„åº”è¯¥æ˜¯**å±äºæµè§ˆå™¨çš„è¡Œä¸º**ã€‚ä¹Ÿå°±æ˜¯è¯´ Javascript æœ¬èº«æ˜¯å•çº¿ç¨‹çš„ï¼Œ**å¹¶æ²¡æœ‰å¼‚æ­¥çš„ç‰¹æ€§**ã€‚

ç”±äº Javascript çš„è¿ç”¨åœºæ™¯æ˜¯æµè§ˆå™¨ï¼Œæµè§ˆå™¨æœ¬èº«æ˜¯å…¸å‹çš„ GUI å·¥ä½œçº¿ç¨‹ï¼ŒGUI å·¥ä½œçº¿ç¨‹åœ¨ç»å¤§å¤šæ•°ç³»ç»Ÿä¸­éƒ½å®ç°ä¸ºäº‹ä»¶å¤„ç†ï¼Œé¿å…é˜»å¡äº¤äº’ï¼Œå› æ­¤äº§ç”Ÿäº† Javascript å¼‚æ­¥åŸºå› ã€‚æ‰€æœ‰æ¶‰åŠåˆ°å¼‚æ­¥çš„æ–¹æ³•å’Œå‡½æ•°éƒ½æ˜¯ç”±æµè§ˆå™¨çš„å¦ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œçš„ã€‚

#### æµè§ˆå™¨ä¸­çš„çº¿ç¨‹

- **æµè§ˆå™¨äº‹ä»¶è§¦å‘çº¿ç¨‹** å½“ä¸€ä¸ªäº‹ä»¶è¢«è§¦å‘æ—¶è¯¥çº¿ç¨‹ä¼šæŠŠäº‹ä»¶æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œç­‰å¾… JavaScript å¼•æ“çš„å¤„ç†ã€‚è¿™äº›äº‹ä»¶å¯ä»¥æ˜¯å½“å‰æ‰§è¡Œçš„ä»£ç å—å¦‚ï¼š**å®šæ—¶ä»»åŠ¡**ã€ä¹Ÿå¯æ¥è‡ªæµè§ˆå™¨å†…æ ¸çš„å…¶ä»–çº¿ç¨‹å¦‚**é¼ æ ‡ç‚¹å‡»**ã€**AJAX å¼‚æ­¥è¯·æ±‚**ç­‰ï¼Œä½†ç”±äº JavaScript æ˜¯å•çº¿ç¨‹ï¼Œæ‰€æœ‰è¿™äº›äº‹ä»¶éƒ½å¾—æ’é˜Ÿç­‰å¾… JavaScript å¼•æ“å¤„ç†ï¼›

- **å®šæ—¶è§¦å‘å™¨çº¿ç¨‹** æµè§ˆå™¨å®šæ—¶è®¡æ•°å™¨**å¹¶ä¸æ˜¯**ç”± JavaScript å¼•æ“è®¡æ•°çš„, å› ä¸º JavaScript å¼•æ“æ˜¯å•çº¿ç¨‹çš„, å¦‚æœå¤„äºé˜»å¡çº¿ç¨‹çŠ¶æ€å°±ä¼šå½±å“è®°è®¡æ—¶çš„å‡†ç¡®, å› æ­¤é€šè¿‡å•ç‹¬çº¿ç¨‹æ¥è®¡æ—¶å¹¶è§¦å‘å®šæ—¶æ˜¯æ›´ä¸ºåˆç†çš„æ–¹æ¡ˆï¼›

- **å¼‚æ­¥ HTTP è¯·æ±‚çº¿ç¨‹** XMLHttpRequest åœ¨è¿æ¥åæ˜¯é€šè¿‡æµè§ˆå™¨æ–°å¼€ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚ï¼Œå°†æ£€æµ‹åˆ°çŠ¶æ€å˜æ›´æ—¶ï¼Œ**å¦‚æœè®¾ç½®æœ‰å›è°ƒå‡½æ•°ï¼Œå¼‚æ­¥çº¿ç¨‹å°±äº§ç”ŸçŠ¶æ€å˜æ›´äº‹ä»¶æ”¾åˆ° JavaScript å¼•æ“çš„å¤„ç†é˜Ÿåˆ—ä¸­** ç­‰å¾…å¤„ç†ï¼›

é€šè¿‡ä»¥ä¸Šäº†è§£ï¼Œå¯ä»¥çŸ¥é“å…¶å® JavaScript **æ˜¯é€šè¿‡ JS å¼•æ“çº¿ç¨‹ä¸æµè§ˆå™¨ä¸­å…¶ä»–çº¿ç¨‹äº¤äº’åä½œå®ç°å¼‚æ­¥**ã€‚

ä½†æ˜¯å›è°ƒå‡½æ•°å…·ä½“ä½•æ—¶åŠ å…¥åˆ° JS å¼•æ“çº¿ç¨‹ä¸­æ‰§è¡Œï¼Ÿæ‰§è¡Œé¡ºåºæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ

æ¥ä¸‹æ¥äº†è§£ä¸€ä¸‹ï¼Œä¸ä¹‹ç›¸å…³çš„ EventLoop æœºåˆ¶

### EventLoop

å…ˆæ¥çœ‹ä¸€äº›æ¦‚å¿µï¼ŒStackï¼ŒHeapï¼ŒQueueï¼Œç›´æ¥ä¸Šå›¾ï¼š

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/q.png)

- é‚£äº›ä¸éœ€è¦å›è°ƒå‡½æ•°çš„æ“ä½œéƒ½å¯å½’ä¸º Stack è¿™ä¸€ç±»

- Heap ç”¨æ¥å­˜å‚¨å£°æ˜çš„å˜é‡ã€å¯¹è±¡

- ä¸€æ—¦æŸä¸ªå¼‚æ­¥ä»»åŠ¡æœ‰äº†å“åº”å°±ä¼šè¢«æ¨å…¥ Queue é˜Ÿåˆ—ä¸­

ä¸€ä¸ªå¤§è‡´çš„æµç¨‹å¦‚ä¸‹ï¼š

JS å¼•æ“çº¿ç¨‹ç”¨æ¥æ‰§è¡Œæ ˆä¸­çš„**åŒæ­¥ä»»åŠ¡**ï¼Œå½“æ‰€æœ‰åŒæ­¥ä»»åŠ¡**æ‰§è¡Œå®Œæ¯•åï¼Œæ ˆè¢«æ¸…ç©º**ï¼Œç„¶åè¯»å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªå¾…å¤„ç†ä»»åŠ¡ï¼Œå¹¶æŠŠ**ç›¸å…³å›è°ƒå‡½æ•°å‹å…¥æ ˆä¸­**ï¼Œå•çº¿ç¨‹å¼€å§‹æ‰§è¡Œæ–°çš„åŒæ­¥ä»»åŠ¡ã€‚

JS å¼•æ“çº¿ç¨‹ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–ä»»åŠ¡æ˜¯ä¸æ–­å¾ªç¯çš„ï¼Œ**æ¯æ¬¡æ ˆè¢«æ¸…ç©ºå**ï¼Œéƒ½ä¼šåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ–°çš„ä»»åŠ¡ï¼Œå¦‚æœæ²¡æœ‰æ–°çš„ä»»åŠ¡ï¼Œå°±ä¼šç­‰å¾…ï¼Œç›´åˆ°æœ‰æ–°çš„ä»»åŠ¡ï¼Œè¿™å°±å«**äº‹ä»¶å¾ªç¯**ã€‚

![](https://raw.githubusercontent.com/leer0911/myPromise/master/doc/img/event.png)

è¿™å¼ å›¾ä¸çŸ¥é“è°ç”»çš„ï¼ŒçœŸçš„æ˜¯éå¸¸æ£’!å…ˆå€Ÿæ¥æè¿°ä¸‹ AJAX å¤§æ¦‚çš„æµç¨‹ï¼š

AJAX è¯·æ±‚å±äºéå¸¸è€—æ—¶çš„å¼‚æ­¥æ“ä½œï¼Œæµè§ˆå™¨æœ‰æä¾›ä¸“é—¨çš„çº¿ç¨‹æ¥å¤„ç†å®ƒã€‚å½“ä¸»çº¿ç¨‹ä¸Šæœ‰è°ƒç”¨ AJAX çš„ä»£ç æ—¶ï¼Œä¼šè§¦å‘å¼‚æ­¥ä»»åŠ¡ã€‚æ‰§è¡Œè¿™ä¸ªå¼‚æ­¥ä»»åŠ¡çš„å·¥ä½œäº¤ç”± AJAX çº¿ç¨‹ï¼Œ**ä¸»çº¿ç¨‹å¹¶æ²¡æœ‰ç­‰å¾…è¿™ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœ**è€Œæ˜¯æ¥ç€æ‰§è¡Œã€‚å‡è®¾ä¸»çº¿ç¨‹ä»£ç åœ¨æŸä¸ªæ—¶åˆ»æ‰§è¡Œå®Œæ¯•ï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶çš„ Stack ä¸ºç©ºã€‚è€Œåœ¨æ—©äº›æ—¶åˆ»ï¼Œå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆåå·²ç»å°†æ¶ˆæ¯å­˜æ”¾åœ¨ Queue ä¸­ï¼Œä»¥ä¾¿ Stack ä¸ºç©ºæ—¶ä»ä¸­æ‹¿å»ä¸€ä¸ªå›è°ƒå‡½æ•°æ¥æ‰§è¡Œã€‚

è¿™èƒŒåè¿ä½œçš„å°±å« `EventLoop`ï¼Œæœ‰äº†ä¸Šé¢çš„å¤§è‡´äº†è§£ã€‚ä¸‹é¢æ¥é‡æ–°äº†è§£ä¸‹ EventLoopï¼š

> å¼‚æ­¥èƒŒåçš„â€œé å±±â€å°±æ˜¯ event loopsã€‚è¿™é‡Œçš„å¼‚æ­¥å‡†ç¡®çš„è¯´åº”è¯¥å«æµè§ˆå™¨çš„ event loops æˆ–è€…è¯´æ˜¯ javaScript è¿è¡Œç¯å¢ƒçš„ event loopsï¼Œå› ä¸º ECMAScript ä¸­æ²¡æœ‰ event loopsï¼Œevent loops æ˜¯åœ¨ HTML Standard å®šä¹‰çš„ã€‚

event loop ç¿»è¯‘å‡ºæ¥å°±æ˜¯äº‹ä»¶å¾ªç¯ï¼Œå¯ä»¥ç†è§£ä¸ºå®ç°å¼‚æ­¥çš„ä¸€ç§æ–¹å¼ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ event loop åœ¨ HTML Standard ä¸­çš„å®šä¹‰ç« èŠ‚ï¼š

> ä¸ºäº†åè°ƒäº‹ä»¶ï¼Œç”¨æˆ·äº¤äº’ï¼Œè„šæœ¬ï¼Œæ¸²æŸ“ï¼Œç½‘ç»œç­‰ï¼Œç”¨æˆ·ä»£ç†å¿…é¡»ä½¿ç”¨æœ¬èŠ‚æ‰€è¿°çš„ event loopã€‚

äº‹ä»¶ï¼Œç”¨æˆ·äº¤äº’ï¼Œè„šæœ¬ï¼Œæ¸²æŸ“ï¼Œç½‘ç»œè¿™äº›éƒ½æ˜¯æˆ‘ä»¬æ‰€ç†Ÿæ‚‰çš„ä¸œè¥¿ï¼Œä»–ä»¬éƒ½æ˜¯ç”± event loop åè°ƒçš„ã€‚è§¦å‘ä¸€ä¸ª click äº‹ä»¶ï¼Œè¿›è¡Œä¸€æ¬¡ ajax è¯·æ±‚ï¼ŒèƒŒåéƒ½æœ‰ event loop åœ¨è¿ä½œã€‚

#### task

> ä¸€ä¸ª event loop æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ª task é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ª task éƒ½æ¥æºäºæŒ‡å®šçš„ä»»åŠ¡æºï¼Œæ¯”å¦‚å¯ä»¥ä¸ºé¼ æ ‡ã€é”®ç›˜äº‹ä»¶æä¾›ä¸€ä¸ª task é˜Ÿåˆ—ï¼Œå…¶ä»–äº‹ä»¶åˆæ˜¯ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—ã€‚å¯ä»¥ä¸ºé¼ æ ‡ã€é”®ç›˜äº‹ä»¶åˆ†é…æ›´å¤šçš„æ—¶é—´ï¼Œä¿è¯äº¤äº’çš„æµç•…ã€‚

task ä¹Ÿè¢«ç§°ä¸º**macrotask**ï¼Œtask é˜Ÿåˆ—è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ï¼Œå°±æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”±æŒ‡å®šçš„ä»»åŠ¡æºå»æä¾›ä»»åŠ¡ã€‚

task ä»»åŠ¡æº:

- setTimeout
- setInterval
- setImmediate
- I/O
- UI rendering

#### microtask

æ¯ä¸€ä¸ª event loop éƒ½æœ‰ä¸€ä¸ª microtask é˜Ÿåˆ—ï¼Œä¸€ä¸ª microtask ä¼šè¢«æ’è¿› microtask é˜Ÿåˆ—è€Œä¸æ˜¯ task é˜Ÿåˆ—ã€‚microtask é˜Ÿåˆ—å’Œ task é˜Ÿåˆ—æœ‰äº›ç›¸ä¼¼ï¼Œéƒ½æ˜¯å…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”±æŒ‡å®šçš„ä»»åŠ¡æºå»æä¾›ä»»åŠ¡ï¼Œä¸åŒçš„æ˜¯ä¸€ä¸ª event loop é‡Œåªæœ‰ä¸€ä¸ª microtask é˜Ÿåˆ—ã€‚

é€šå¸¸è®¤ä¸ºæ˜¯ microtask ä»»åŠ¡æºæœ‰ï¼š

- process.nextTick
- promises
- Object.observe
- MutationObserver

#### ä¸€é“å…³äº EventLoop çš„é¢è¯•é¢˜

```ts
console.log('start');

setTimeout(function() {
  console.log('setTimeout');
}, 0);

Promise.resolve()
  .then(function() {
    console.log('promise1');
  })
  .then(function() {
    console.log('promise2');
  });

console.log('end');

// start
// end
// promise1
// promise2
// setTimeout
```

> ä¸Šé¢çš„é¡ºåºæ˜¯åœ¨ chrome è¿è¡Œå¾—å‡ºçš„ï¼Œæœ‰è¶£çš„æ˜¯åœ¨ safari 9.1.2 ä¸­æµ‹è¯•ï¼Œpromise1 promise2 ä¼šåœ¨ setTimeout çš„åè¾¹ï¼Œè€Œåœ¨ safari 10.0.1 ä¸­å¾—åˆ°äº†å’Œ chrome ä¸€æ ·çš„ç»“æœã€‚promise åœ¨ä¸åŒæµè§ˆå™¨çš„å·®å¼‚æ­£æºäºæœ‰çš„æµè§ˆå™¨å°† then æ”¾å…¥äº† macro-task é˜Ÿåˆ—ï¼Œæœ‰çš„æ”¾å…¥äº† micro-task é˜Ÿåˆ—ã€‚

#### EventLoop å°ç»“

event loop æ¶‰åŠåˆ°çš„ä¸œè¥¿å¾ˆå¤šï¼Œä½†æœ¬æ–‡æ€•é‡ç‚¹åç¦»ï¼Œè¿™é‡Œåªæ˜¯æåŠå¯èƒ½ä¸ promise ç›¸å…³çš„çŸ¥è¯†ç‚¹ã€‚å¦‚æœæƒ³æ·±å…¥äº†è§£çš„åŒå­¦ï¼Œå»ºè®®çœ‹å®Œ[è¿™ç¯‡](https://github.com/aooy/blog/issues/5)å¿…å®šä¼šå—ç›ŠåŒªæµ…ã€‚

## ä»€ä¹ˆæ˜¯ asap

`as soon as possible` è‹±æ–‡çš„ç¼©å†™ï¼Œåœ¨ promise ä¸­èµ·åˆ°çš„ä½œç”¨æ˜¯å°½å¿«å“åº”å˜åŒ–ã€‚

åœ¨ **Promises/A+è§„èŒƒ** çš„ **Notes 3.1** ä¸­æåŠäº† promise çš„ then æ–¹æ³•å¯ä»¥é‡‡ç”¨â€œå®ä»»åŠ¡ï¼ˆmacro-taskï¼‰â€æœºåˆ¶æˆ–è€…â€œå¾®ä»»åŠ¡ï¼ˆmicro-taskï¼‰â€æœºåˆ¶æ¥å®ç°ã€‚

æœ¬é¡¹ç›®ï¼Œé‡‡ç”¨ `macro-task` æœºåˆ¶

```ts
  private asap(callback) {
    setTimeout(() => {
      callback.call(this);
    }, 1);
  }
```

æˆ–è€… MutationObserver æ¨¡å¼ï¼š

```ts
function flush() {
...
}
function useMutationObserver() {
  var iterations = 0;
  var observer = new MutationObserver(flush);
  var node = document.createTextNode('');
  observer.observe(node, { characterData: true });

  return function () {
    node.data = iterations = ++iterations % 2;
  };
}
```

åˆæ¬¡çœ‹è¿™ä¸ª `useMutationObserver` `å‡½æ•°æ€»ä¼šå¾ˆæœ‰ç–‘æƒ‘ï¼ŒMutationObserver` ä¸æ˜¯ç”¨æ¥è§‚å¯Ÿ dom çš„å˜åŒ–çš„å—ï¼Œè¿™æ ·å‡­ç©ºé€ å‡ºä¸€ä¸ªèŠ‚ç‚¹æ¥åå¤ä¿®æ”¹å®ƒçš„å†…å®¹ï¼Œæ¥è§¦å‘è§‚å¯Ÿçš„å›è°ƒå‡½æ•°æœ‰ä½•æ„ä¹‰ï¼Ÿ

ç­”æ¡ˆå°±æ˜¯ä½¿ç”¨ `Mutation` äº‹ä»¶å¯ä»¥å¼‚æ­¥æ‰§è¡Œæ“ä½œï¼ˆä¾‹å­ä¸­çš„ flush å‡½æ•°ï¼‰ï¼Œä¸€æ˜¯å¯ä»¥å°½å¿«å“åº”å˜åŒ–ï¼ŒäºŒæ˜¯å¯ä»¥å»é™¤é‡å¤çš„è®¡ç®—ã€‚

æˆ–è€… node ç¯å¢ƒä¸‹ï¼š

```ts
function useNextTick() {
  return () => process.nextTick(flush);
}
```

## å‰ç«¯å®‰å…¨æ„Ÿ

æ—¢ç„¶æ ‡é¢˜æåˆ°äº† `å‰ç«¯å®‰å…¨æ„Ÿ`ï¼Œå½“ç„¶è¦è¯´ç‚¹ä»€ä¹ˆã€‚ç°å¦‚ä»Šå‰ç«¯å¤„äºæ¨¡å—åŒ–å¼€å‘çš„é¼ç››æ—¶æœŸï¼Œé¢å¯¹ [npm](https://www.npmjs.com/) é‚£æˆåƒä¸Šä¸‡çš„ "åç‰ŒåŒ…åŒ…" å¾ˆå¤šåƒæˆ‘è¿™æ ·çš„å°ç™½éš¾å…ä¼šè¿·å¤±è‡ªæˆ‘ï¼Œæ¸æ¸æ²¡æœ‰äº†å®‰å…¨æ„Ÿã€‚

æ˜¯åšæ‹¿æ¥ä¸»ä¹‰ï¼Œè¿˜æ˜¯åƒç¬”è€…ä¸€æ ·å¶å°”ç ”ç©¶ä¸‹åº•å±‚åŸç†ï¼Œçœ‹çœ‹åˆ«äººçš„ä»£ç ï¼Œè‡ªå·±æ’¸ä¸€éæ¥æ„Ÿæ‚Ÿå…¶ä¸­çš„çœŸè°›æ¥æå‡å®‰å…¨æ„Ÿã€‚

åšå‰ç«¯ä¹Ÿæœ‰æ®µæ—¶æ—¥äº†ï¼Œè¢«ä¸šåŠ¡åŸ‹æ²¡çš„é‚£äº›å¹´ï¼ŒçœŸæ˜¯æ„Ÿå¹!å›æƒ³æ›¾ç»å·®ç‚¹å»åšè®¾è®¡çš„æˆ‘ç»ˆäºè¦å…¥é—¨å‰ç«¯äº†ï¼Œå¿ƒä¸­éš¾å…æƒ³å»æ“ä¸€é¡¿ï¼Œé‚£å°±å†™åˆ°è¿™å§!

## ç»“è¯­

å†™çš„æœ‰ç‚¹å¤šï¼Œå¥½ç´¯ã€‚å¸Œæœ›å¯¹å¤§å®¶æœ‰æ‰€å¸®åŠ©ã€‚

[æºç ](https://github.com/leer0911/myPromise)

## å‚è€ƒ

[Promises/A+](https://promisesaplus.com/)
[MDN Promises](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise)
[Promise ä½¿ç”¨](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Using_promises)
[Event loop](https://github.com/aooy/blog/issues/5)
